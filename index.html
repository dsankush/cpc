<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coromandel CPC ‚Äî Campaign Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#f8fafc;
      --panel:#ffffff;
      --card:#ffffff;
      --card-hover:#f1f5f9;
      --muted:#64748b;
      --text:#0f172a;
      --acc1:#0ea5e9;
      --acc2:#f97316;
      --acc3:#10b981;
      --acc4:#8b5cf6;
      --ring:#e2e8f0;
      --border:#cbd5e1;
      --shadow:rgba(15,23,42,.08);
      --shadow-lg:rgba(15,23,42,.12);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%;overflow-x:hidden}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:linear-gradient(135deg, #e0f2fe 0%, #fef3c7 50%, #fce7f3 100%);
      background-attachment:fixed;color:var(--text)}
    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh}
    
    /* Header */
    header{position:sticky;top:0;z-index:30;
      backdrop-filter:saturate(180%) blur(20px);
      background:rgba(255,255,255,.95);
      border-bottom:2px solid var(--ring);
      box-shadow:0 4px 20px var(--shadow)}
    .bar{display:flex;align-items:center;gap:20px;padding:16px 24px;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:12px;font-weight:700;font-size:18px;color:var(--text)}
    .dot{width:12px;height:12px;border-radius:999px;
      background:linear-gradient(135deg,var(--acc1),var(--acc3));
      box-shadow:0 0 20px rgba(14,165,233,.4);
      animation:pulse 2s ease-in-out infinite}
    @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.15);opacity:.7}}
    .title{letter-spacing:.5px}
    .header-actions{margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;
      padding:10px 16px;border-radius:12px;border:2px solid var(--acc1);
      background:linear-gradient(135deg,var(--acc1),#0284c7);
      color:white;font-weight:600;cursor:pointer;font-size:13px;
      transition:all .3s ease;white-space:nowrap;box-shadow:0 4px 12px rgba(14,165,233,.25)}
    .btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(14,165,233,.4)}
    .btn-logout{background:linear-gradient(135deg,#ef4444,#dc2626);
      border-color:#ef4444;box-shadow:0 4px 12px rgba(239,68,68,.25)}
    .btn-logout:hover{box-shadow:0 8px 24px rgba(239,68,68,.4)}

    /* Layout */
    .main{display:grid;grid-template-columns:300px 1fr;gap:24px;padding:24px;max-width:2000px;margin:0 auto}
    .side{display:flex;flex-direction:column;gap:16px;position:sticky;top:90px;height:fit-content}
    .panel{background:var(--panel);border:2px solid var(--ring);border-radius:16px;padding:20px;
      box-shadow:0 4px 16px var(--shadow);transition:all .3s ease}
    .panel:hover{border-color:var(--acc1);box-shadow:0 8px 24px var(--shadow-lg)}

    /* Filters */
    .filters .group{display:flex;flex-direction:column;gap:8px;margin-bottom:16px}
    .filters label{font-size:12px;color:var(--muted);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
    .filters select,.filters input{width:100%;padding:12px 14px;border-radius:10px;
      border:2px solid var(--ring);background:var(--bg);color:var(--text);outline:none;
      font-size:14px;transition:all .2s ease}
    .filters select:hover,.filters input:hover{border-color:var(--acc1)}
    .filters select:focus,.filters input:focus{border-color:var(--acc1);box-shadow:0 0 0 3px rgba(14,165,233,.1)}

    /* Content Grid */
    .content{display:grid;grid-template-columns:repeat(12,1fr);gap:24px}
    .card{background:var(--card);border:2px solid var(--ring);border-radius:16px;
      padding:24px;min-height:160px;display:flex;flex-direction:column;
      box-shadow:0 4px 16px var(--shadow);transition:all .3s ease;position:relative;overflow:hidden}
    .card::before{content:'';position:absolute;top:0;left:0;right:0;height:4px;
      background:linear-gradient(90deg,var(--acc1),var(--acc3),var(--acc2));opacity:0;transition:opacity .3s}
    .card:hover{border-color:var(--acc1);transform:translateY(-4px);
      box-shadow:0 12px 32px var(--shadow-lg)}
    .card:hover::before{opacity:1}
    .card h3{margin:0 0 12px;font-size:13px;color:var(--muted);font-weight:700;
      text-transform:uppercase;letter-spacing:1px}
    
    /* KPI Cards */
    .kpi-main{font-size:48px;font-weight:700;line-height:1;
      background:linear-gradient(135deg,var(--acc1),var(--acc3));
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      background-clip:text;margin-bottom:12px}
    .kpi-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:16px}
    .kpi-item{background:linear-gradient(135deg,rgba(14,165,233,.1),rgba(16,185,129,.08));
      border:2px solid rgba(14,165,233,.2);
      border-radius:12px;padding:12px;text-align:center;transition:all .3s ease}
    .kpi-item:hover{transform:translateY(-2px);border-color:var(--acc1)}
    .kpi-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;font-weight:600}
    .kpi-value{font-size:24px;font-weight:700;margin-top:4px}
    .kpi-item:nth-child(1) .kpi-value{color:var(--acc3)}
    .kpi-item:nth-child(2) .kpi-value{color:var(--acc2)}
    .kpi-item:nth-child(3) .kpi-value{color:var(--acc4)}

    /* India Map */
    #indiaMapContainer{width:100%;height:600px;position:relative;background:var(--bg);
      border-radius:16px;overflow:hidden;border:2px solid var(--ring)}
    #indiaMap{width:100%;height:100%}
    .state-region{cursor:pointer;transition:all .2s ease;stroke:#94a3b8;stroke-width:1.5}
    .state-region:hover{opacity:.8;stroke:#0ea5e9;stroke-width:2}
    .map-tooltip{position:absolute;background:rgba(255,255,255,.98);
      padding:12px 16px;border-radius:10px;pointer-events:none;
      box-shadow:0 8px 24px rgba(15,23,42,.15);border:2px solid var(--acc1);
      font-size:13px;font-weight:600;color:var(--text);display:none;z-index:100}
    .legend{position:absolute;bottom:20px;right:20px;background:rgba(255,255,255,.95);
      padding:16px;border-radius:12px;box-shadow:0 4px 16px var(--shadow);border:2px solid var(--ring)}
    .legend-title{font-size:12px;font-weight:700;color:var(--muted);margin-bottom:8px;text-transform:uppercase}
    .legend-item{display:flex;align-items:center;gap:8px;margin:6px 0;font-size:11px}
    .legend-color{width:24px;height:16px;border-radius:4px;border:1px solid var(--border)}

    .footer{padding:16px 24px;color:var(--muted);border-top:2px solid var(--ring);
      text-align:center;font-size:13px;background:var(--panel);font-weight:500}

    /* Login */
    .overlay{position:fixed;inset:0;
      background:linear-gradient(135deg, rgba(224,242,254,.95) 0%, rgba(254,243,199,.95) 50%, rgba(252,231,243,.95) 100%);
      display:grid;place-items:center;z-index:100;backdrop-filter:blur(10px)}
    .login{width:min(92vw,420px);background:white;border:2px solid var(--acc1);
      border-radius:20px;padding:32px;
      box-shadow:0 24px 80px rgba(15,23,42,.2);
      animation:slideIn .5s ease}
    @keyframes slideIn{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
    .login h2{margin:0 0 8px;font-size:24px;color:var(--text)}
    .login p{margin:0 0 24px;color:var(--muted);font-size:14px}
    .field{display:flex;flex-direction:column;gap:8px;margin:16px 0}
    .field label{font-size:12px;color:var(--muted);font-weight:600}
    .field input{padding:14px;border-radius:12px;border:2px solid var(--ring);
      background:var(--bg);color:var(--text);font-size:14px}
    .field input:focus{outline:none;border-color:var(--acc1);box-shadow:0 0 0 3px rgba(14,165,233,.1)}
    .err{color:#ef4444;font-size:13px;min-height:18px;margin-top:8px;font-weight:500}

    @media (max-width: 1100px){
      .main{grid-template-columns:1fr}
      .side{position:relative;top:0}
      #indiaMapContainer{height:500px}
    }
    @media (max-width: 640px){
      .bar{padding:12px 16px}
      .main{padding:16px;gap:16px}
      .kpi-grid{grid-template-columns:1fr}
      .header-actions{width:100%;justify-content:flex-start}
      #indiaMapContainer{height:400px}
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="bar">
      <div class="logo"><span class="dot"></span><span class="title">CPC Campaign Dashboard</span></div>
      <div class="header-actions">
        <button class="btn" id="downloadBtn">üì• Download Data</button>
        <button class="btn btn-logout" id="logoutBtn">üö™ Logout</button>
      </div>
    </div>
  </header>

  <main class="main">
    <aside class="side">
      <div class="panel filters">
        <h3 style="margin-bottom:20px;font-size:16px;color:var(--text)">üîç Filters</h3>
        <div class="group">
          <label for="dateFrom">Date From</label>
          <input id="dateFrom" type="date" />
        </div>
        <div class="group">
          <label for="dateTo">Date To</label>
          <input id="dateTo" type="date" />
        </div>
        <div class="group">
          <label for="state">State</label>
          <select id="state"></select>
        </div>
        <div class="group">
          <label for="district">District</label>
          <select id="district"></select>
        </div>
        <div class="group">
          <label for="retailer">Retailer</label>
          <select id="retailer"></select>
        </div>
        <div class="group">
          <label for="product">Product</label>
          <select id="product"></select>
        </div>
        <div class="group">
          <label for="qtyMin">Quantity (‚â•)</label>
          <input id="qtyMin" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="group">
          <label for="status">Approved Status</label>
          <select id="status"></select>
        </div>
        <button class="btn" id="resetBtn" style="width:100%;margin-top:8px">üîÑ Reset Filters</button>
      </div>
      <div class="panel" style="padding:16px">
        <div style="font-size:11px;color:var(--muted);margin-bottom:6px;font-weight:600">CSV SOURCE:</div>
        <div style="word-break:break-all;font-size:12px;font-family:monospace;color:var(--acc1);font-weight:500" id="csvPath">./data.csv</div>
      </div>
    </aside>

    <section class="content">
      <!-- Total Scans with sub-metrics -->
      <div class="card" style="grid-column: span 6">
        <h3>üìä Total Scans</h3>
        <div class="kpi-main" id="kpiTotalBig">0</div>
        <div class="kpi-grid">
          <div class="kpi-item">
            <div class="kpi-label">Approved</div>
            <div class="kpi-value" id="kpiYes">0</div>
          </div>
          <div class="kpi-item">
            <div class="kpi-label">Rejected</div>
            <div class="kpi-value" id="kpiNo">0</div>
          </div>
          <div class="kpi-item">
            <div class="kpi-label">Pending</div>
            <div class="kpi-value" id="kpiPending">0</div>
          </div>
        </div>
      </div>

      <!-- Status Chart -->
      <div class="card" style="grid-column: span 6">
        <h3>‚úÖ Submission Status</h3>
        <canvas id="statusChart" height="200"></canvas>
      </div>

      <!-- Trend Chart -->
      <div class="card" style="grid-column: span 12">
        <h3>üìà Time Trend (Scans per Day)</h3>
        <canvas id="trendChart" height="140"></canvas>
      </div>

      <!-- Top States Table -->
      <div class="card" style="grid-column: span 6">
        <h3>üèÜ Top States by Scans</h3>
        <div id="statesTable" style="overflow-y:auto;max-height:380px;margin-top:12px"></div>
      </div>

      <!-- Retailer Performance -->
      <div class="card" style="grid-column: span 6">
        <h3>üè™ Retailer Performance</h3>
        <canvas id="retailerChart" height="180"></canvas>
      </div>

      <!-- District Scans -->
      <div class="card" style="grid-column: span 6">
        <h3>üèòÔ∏è District-wise Scans</h3>
        <canvas id="districtChart" height="180"></canvas>
      </div>

      <!-- Product Basket -->
      <div class="card" style="grid-column: span 6">
        <h3>üõí Product Basket</h3>
        <canvas id="productChart" height="180"></canvas>
      </div>

      <!-- India Map - Now at bottom and full width -->
      <div class="card" style="grid-column: span 12">
        <h3>üó∫Ô∏è India - State-wise Distribution</h3>
        <div id="indiaMapContainer">
          <svg id="indiaMap" viewBox="0 0 400 450" preserveAspectRatio="xMidYMid meet"></svg>
          <div class="map-tooltip" id="mapTooltip"></div>
          <div class="legend">
            <div class="legend-title">Scan Intensity</div>
            <div class="legend-item"><div class="legend-color" style="background:#dcfce7"></div><span>Low (0-25%)</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#86efac"></div><span>Medium (25-50%)</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#22c55e"></div><span>High (50-75%)</span></div>
            <div class="legend-item"><div class="legend-color" style="background:#15803d"></div><span>Very High (75-100%)</span></div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="footer">
    ¬© 2025 Coromandel CPC ‚Äî Empowering Agriculture
  </div>
</div>

<!-- Login Overlay -->
<div class="overlay" id="loginOverlay">
  <form class="login" id="loginForm">
    <h2>üîê Secure Access</h2>
    <p>Please authenticate to view the campaign dashboard.</p>
    <div class="field">
      <label>Username</label>
      <input id="u" autocomplete="username" placeholder="Enter username" />
    </div>
    <div class="field">
      <label>Password</label>
      <input id="p" type="password" autocomplete="current-password" placeholder="Enter password" />
    </div>
    <button class="btn" type="submit" style="width:100%;margin-top:8px">Login</button>
    <div class="err" id="err"></div>
  </form>
</div>

<script>
  const CSV_URL = './data.csv';
  document.getElementById('csvPath').textContent = CSV_URL;

  // Login
  const VALID_USER = 'digicides';
  const VALID_PASS = 'coro@cpc';
  const overlay = document.getElementById('loginOverlay');
  const form = document.getElementById('loginForm');
  const errEl = document.getElementById('err');
  const LS_KEY = 'cpc_login_ok';

  function unlock(){ overlay.style.display='none'; }
  if(localStorage.getItem(LS_KEY)==='1'){ unlock(); }
  
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const u = document.getElementById('u').value.trim();
    const p = document.getElementById('p').value;
    if(u===VALID_USER && p===VALID_PASS){
      localStorage.setItem(LS_KEY,'1');
      unlock();
    } else {
      errEl.textContent = 'Invalid credentials. Please try again.';
    }
  });

  // Logout
  document.getElementById('logoutBtn').addEventListener('click', ()=>{
    if(confirm('Are you sure you want to logout?')){
      localStorage.removeItem(LS_KEY);
      location.reload();
    }
  });

  // Utilities
  const trim = (s)=> (s==null?'' : String(s).trim());
  const toDateKey = (dt)=>{
    if(!dt) return '';
    const d = new Date(dt.replace(/-/g,'/'));
    if(isNaN(d)) return '';
    return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  };
  function uniqSorted(arr){ return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }
  function parseProducts(cartStr){
    const map = new Map();
    const s = trim(cartStr);
    if(!s) return map;
    const parts = s.split(',');
    for(const raw of parts){
      const item = raw.trim();
      const m = item.match(/^(.+?)\s*-\s*qty\s*(\d+)/i) || item.match(/^(.+?)\s*$/);
      if(m){
        const name = trim(m[1]).replace(/\s{2,}/g,' ');
        const q = m[2] ? Number(m[2]) : 1;
        map.set(name, (map.get(name)||0)+ (isFinite(q)? q : 1));
      }
    }
    return map;
  }

  // State
  let RAW = [];
  let FILTERS = { dateFrom:'', dateTo:'', state:'', district:'', retailer:'', product:'', qtyMin:0, status:'' };

  // DOM
  const selDateFrom = document.getElementById('dateFrom');
  const selDateTo = document.getElementById('dateTo');
  const selState = document.getElementById('state');
  const selDistrict = document.getElementById('district');
  const selRetailer = document.getElementById('retailer');
  const selProduct = document.getElementById('product');
  const inpQtyMin = document.getElementById('qtyMin');
  const selStatus = document.getElementById('status');
  
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    FILTERS = { dateFrom:'', dateTo:'', state:'', district:'', retailer:'', product:'', qtyMin:0, status:'' };
    selDateFrom.value = selDateTo.value = '';
    selState.value = selDistrict.value = selRetailer.value = selProduct.value = selStatus.value = '';
    inpQtyMin.value = '';
    render();
  });

  // Download CSV
  document.getElementById('downloadBtn').addEventListener('click', ()=>{
    const filtered = applyFilters(RAW);
    if(filtered.length === 0){ alert('No data to download!'); return; }
    const csv = Papa.unparse(filtered);
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'cpc_data_export_' + new Date().toISOString().slice(0,10) + '.csv';
    a.click();
    URL.revokeObjectURL(url);
  });

  // Charts
  const charts = {};
  function makeChart(id, type, data, opts){
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]){ 
      charts[id].data = data; 
      charts[id].options = opts; 
      charts[id].update(); 
      return charts[id]; 
    }
    charts[id] = new Chart(ctx, { type, data, options: opts });
    return charts[id];
  }
  function palette(n){
    const base = [ '#0ea5e9','#f97316','#10b981','#8b5cf6','#ec4899','#eab308','#3b82f6','#14b8a6','#f43f5e' ];
    const arr = []; for(let i=0;i<n;i++) arr.push(base[i%base.length]);
    return arr;
  }

  // Apply Filters
  function applyFilters(rows){
    const f = FILTERS;
    return rows.filter(r=>{
      if(f.dateFrom || f.dateTo){
        const scanDate = toDateKey(trim(r['Scan Date']));
        if(f.dateFrom && scanDate < f.dateFrom) return false;
        if(f.dateTo && scanDate > f.dateTo) return false;
      }
      if(f.state && trim(r.State)!==f.state) return false;
      if(f.district && trim(r.District)!==f.district) return false;
      if(f.retailer && trim(r['Retailer Name'])!==f.retailer) return false;
      if(f.status && trim((r['Submission Status']||'').toLowerCase())!==f.status.toLowerCase()) return false;
      if(f.product || (f.qtyMin||0)>0){
        const map = parseProducts(r['Cart Items']);
        if(f.product){
          const has = map.has(f.product);
          if(!has) return false;
          if((f.qtyMin||0)>0 && (map.get(f.product)||0) < f.qtyMin) return false;
        } else if((f.qtyMin||0)>0){
          let ok=false; for(const v of map.values()){ if(v>=f.qtyMin){ ok=true; break; } }
          if(!ok) return false;
        }
      }
      return true;
    });
  }

  function updateKpis(rows){
    const total = rows.length;
    const yes = rows.filter(r=>/^yes$/i.test(trim(r['Submission Status']))).length;
    const pending = rows.filter(r=>/^pending$/i.test(trim(r['Submission Status']))).length;
    const no = rows.filter(r=>/^no$/i.test(trim(r['Submission Status']))).length;
    
    document.getElementById('kpiTotalBig').textContent = total.toLocaleString();
    document.getElementById('kpiYes').textContent = yes.toLocaleString();
    document.getElementById('kpiNo').textContent = no.toLocaleString();
    document.getElementById('kpiPending').textContent = pending.toLocaleString();
  }

  function buildCounts(rows, key){
    const m = new Map();
    for(const r of rows){
      const k = trim(r[key]); if(!k) continue;
      m.set(k, (m.get(k)||0)+1);
    }
    return [...m.entries()].sort((a,b)=>b[1]-a[1]);
  }

  function renderStatesTable(rows){
    const states = buildCounts(rows, 'State').slice(0, 10);
    let html = '<div style="font-size:13px">';
    states.forEach((s, i)=>{
      const bar = Math.round((s[1] / (states[0][1] || 1)) * 100);
      html += `<div style="margin-bottom:14px">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px">
          <span style="font-weight:600;color:var(--text)">${i+1}. ${s[0]}</span>
          <span style="color:var(--acc1);font-weight:700">${s[1]}</span>
        </div>
        <div style="width:100%;height:8px;background:rgba(14,165,233,.12);border-radius:4px;overflow:hidden">
          <div style="width:${bar}%;height:100%;background:linear-gradient(90deg,var(--acc1),var(--acc3));border-radius:4px"></div>
        </div>
      </div>`;
    });
    html += '</div>';
    document.getElementById('statesTable').innerHTML = html;
  }

  function renderCharts(rows){
    // Status
    const sYes = rows.filter(r=>/^yes$/i.test(trim(r['Submission Status']))).length;
    const sNo = rows.filter(r=>/^no$/i.test(trim(r['Submission Status']))).length;
    const sPending = rows.filter(r=>/^pending$/i.test(trim(r['Submission Status']))).length;
    makeChart('statusChart','doughnut',{
      labels:['Approved','Rejected','Pending'],
      datasets:[{ data:[sYes,sNo,sPending], backgroundColor:['#10b981','#f97316','#8b5cf6'], borderWidth:0 }]
    },{
      plugins:{ legend:{ labels:{ color: '#475569', padding:15, font:{size:13,weight:'600'} } } },
      cutout:'65%'
    });

    // Trend
    const trendMap = new Map();
    for(const r of rows){ const k = toDateKey(trim(r['Scan Date'])); if(k) trendMap.set(k,(trendMap.get(k)||0)+1); }
    const trend = [...trendMap.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
    makeChart('trendChart','line',{
      labels: trend.map(x=>x[0]),
      datasets:[{ 
        data: trend.map(x=>x[1]), 
        borderColor:'#0ea5e9',
        backgroundColor:'rgba(14,165,233,.15)',
        borderWidth:3, 
        tension:.4,
        fill:true,
        pointRadius:4,
        pointHoverRadius:6,
        pointBackgroundColor:'#0ea5e9',
        pointBorderColor:'#fff',
        pointBorderWidth:2
      }]
    },{ 
      scales:{ 
        x:{ ticks:{ color:'#64748b', maxRotation:45, font:{weight:'500'} }, grid:{display:false} }, 
        y:{ ticks:{ color:'#64748b', font:{weight:'500'} }, grid:{ color:'#e2e8f0' } } 
      }, 
      plugins:{ legend:{ display:false } } 
    });

    // Retailer
    const retailers = buildCounts(rows,'Retailer Name').slice(0,10);
    makeChart('retailerChart','bar',{
      labels: retailers.map(x=>x[0]),
      datasets:[{ data: retailers.map(x=>x[1]), backgroundColor: palette(retailers.length), borderWidth:0, borderRadius:6 }]
    },{ 
      indexAxis:'y', 
      plugins:{ legend:{ display:false } }, 
      scales:{ x:{ ticks:{ color:'#64748b', font:{weight:'500'} }, grid:{color:'#e2e8f0'} }, y:{ ticks:{ color:'#0f172a',font:{size:11,weight:'600'} }, grid:{display:false} } } 
    });

    // District
    const districts = buildCounts(rows,'District').slice(0,10);
    makeChart('districtChart','bar',{
      labels: districts.map(x=>x[0]),
      datasets:[{ data: districts.map(x=>x[1]), backgroundColor: palette(districts.length), borderWidth:0, borderRadius:6 }]
    },{ 
      indexAxis:'y', 
      plugins:{ legend:{ display:false } }, 
      scales:{ x:{ ticks:{ color:'#64748b', font:{weight:'500'} }, grid:{color:'#e2e8f0'} }, y:{ ticks:{ color:'#0f172a',font:{size:11,weight:'600'} }, grid:{display:false} } } 
    });

    // Product
    const pMap = new Map();
    for(const r of rows){
      const m = parseProducts(r['Cart Items']);
      for(const [name,qty] of m){ pMap.set(name,(pMap.get(name)||0)+qty); }
    }
    const pArr = [...pMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,16);
    makeChart('productChart','bar',{
      labels: pArr.map(x=>x[0]),
      datasets:[{ 
        data: pArr.map(x=>x[1]), 
        backgroundColor: palette(pArr.length), 
        borderWidth:0,
        borderRadius:8
      }]
    },{ 
      plugins:{ legend:{ display:false } }, 
      scales:{ 
        x:{ ticks:{ color:'#0f172a', maxRotation:45, minRotation:20, font:{size:11,weight:'600'} }, grid:{display:false} }, 
        y:{ ticks:{ color:'#64748b', font:{weight:'500'} }, grid:{color:'#e2e8f0'} } 
      } 
    });
  }

  // India Map with accurate state boundaries
  const stateCoords = {
    'Jammu and Kashmir': 'M174,48 L176,46 L178,44 L182,43 L186,42 L190,43 L194,45 L197,48 L199,52 L200,56 L199,60 L197,63 L194,65 L190,66 L186,66 L183,65 L180,63 L177,60 L175,56 L174,52 Z',
    'Ladakh': 'M200,30 L205,28 L210,28 L215,30 L218,33 L220,37 L220,42 L218,46 L215,49 L210,51 L205,51 L200,49 L197,46 L195,42 L195,37 L197,33 Z',
    'Himachal Pradesh': 'M186,68 L190,67 L194,68 L197,70 L199,73 L200,77 L199,81 L197,84 L194,86 L190,87 L186,86 L183,84 L181,81 L180,77 L181,73 L183,70 Z',
    'Punjab': 'M175,70 L179,69 L183,70 L186,72 L188,75 L189,79 L188,83 L186,86 L183,88 L179,89 L175,88 L172,86 L170,83 L169,79 L170,75 L172,72 Z',
    'Chandigarh': 'M180,77 L181,76 L182,77 L181,78 Z',
    'Uttarakhand': 'M200,78 L204,77 L208,78 L211,80 L213,83 L214,87 L213,91 L211,94 L208,96 L204,97 L200,96 L197,94 L195,91 L194,87 L195,83 L197,80 Z',
    'Haryana': 'M180,88 L184,87 L188,88 L191,90 L193,93 L194,97 L193,101 L191,104 L188,106 L184,107 L180,106 L177,104 L175,101 L174,97 L175,93 L177,90 Z',
    'Delhi': 'M186,98 L187,97 L188,98 L187,99 Z',
    'Rajasthan': 'M140,100 L145,99 L150,100 L155,102 L160,105 L165,109 L169,114 L172,120 L174,127 L175,134 L174,141 L172,148 L169,154 L165,159 L160,163 L155,166 L150,167 L145,167 L140,165 L135,162 L131,158 L128,153 L126,147 L125,140 L126,133 L128,126 L131,120 L135,114 L138,108 Z',
    'Uttar Pradesh': 'M195,100 L200,99 L205,100 L210,102 L215,105 L220,109 L224,114 L227,120 L229,127 L230,134 L229,141 L227,148 L224,154 L220,159 L215,163 L210,166 L205,167 L200,167 L195,165 L191,162 L188,158 L186,153 L185,147 L186,140 L188,133 L191,126 L194,120 L197,114 L200,108 L203,102 Z',
    'Bihar': 'M232,148 L237,147 L242,148 L246,150 L249,153 L251,157 L252,161 L251,165 L249,168 L246,170 L242,171 L237,171 L233,169 L230,166 L228,162 L227,158 L228,154 L230,151 Z',
    'Sikkim': 'M253,130 L254,129 L255,130 L254,131 Z',
    'Arunachal Pradesh': 'M260,115 L268,113 L276,114 L283,117 L288,122 L291,128 L292,135 L290,141 L286,146 L280,149 L273,150 L266,148 L260,144 L256,138 L254,131 L254,124 L256,118 Z',
    'Nagaland': 'M280,152 L283,151 L286,152 L288,154 L289,157 L288,160 L286,162 L283,163 L280,162 L278,160 L277,157 L278,154 Z',
    'Manipur': 'M283,165 L285,164 L287,165 L288,167 L288,170 L287,172 L285,173 L283,172 L282,170 L282,167 Z',
    'Mizoram': 'M280,175 L282,174 L284,175 L285,177 L285,179 L284,181 L282,182 L280,181 L279,179 L279,177 Z',
    'Tripura': 'M275,168 L277,167 L279,168 L280,170 L280,172 L279,174 L277,175 L275,174 L274,172 L274,170 Z',
    'Meghalaya': 'M268,155 L271,154 L274,155 L276,157 L277,160 L276,163 L274,165 L271,166 L268,165 L266,163 L265,160 L266,157 Z',
    'Assam': 'M254,135 L262,133 L270,135 L276,139 L280,144 L282,150 L280,156 L276,160 L270,162 L262,163 L254,161 L248,157 L245,152 L244,146 L246,140 L250,136 Z',
    'West Bengal': 'M240,172 L245,171 L250,172 L254,174 L257,177 L259,181 L260,185 L259,189 L257,192 L254,194 L250,195 L245,195 L241,193 L238,190 L236,186 L235,182 L236,178 L238,175 Z',
    'Jharkhand': 'M228,168 L233,167 L238,168 L242,170 L245,173 L247,177 L248,181 L247,185 L245,188 L242,190 L238,191 L233,191 L229,189 L226,186 L224,182 L223,178 L224,174 L226,171 Z',
    'Odisha': 'M238,193 L243,192 L248,193 L252,195 L255,198 L257,202 L258,207 L257,212 L255,216 L252,219 L248,221 L243,222 L239,221 L235,218 L232,214 L230,209 L229,204 L230,199 L232,196 Z',
    'Chhattisgarh': 'M215,168 L220,167 L225,168 L229,170 L232,173 L234,177 L235,181 L234,185 L232,188 L229,190 L225,191 L220,191 L216,189 L213,186 L211,182 L210,178 L211,174 L213,171 Z',
    'Madhya Pradesh': 'M175,148 L182,147 L189,148 L196,150 L203,153 L209,157 L214,162 L217,168 L219,174 L219,181 L217,187 L214,192 L209,196 L203,199 L196,200 L189,200 L182,198 L176,195 L171,190 L167,184 L165,177 L165,170 L167,163 L171,157 L174,152 Z',
    'Gujarat': 'M120,150 L127,149 L134,151 L140,154 L145,159 L149,165 L151,172 L152,179 L151,186 L149,192 L145,197 L140,201 L134,203 L127,204 L121,203 L115,200 L110,196 L106,190 L104,183 L104,176 L106,169 L110,163 L115,158 L119,154 Z',
    'Daman and Diu': 'M128,192 L129,191 L130,192 L129,193 Z',
    'Dadra and Nagar Haveli': 'M135,195 L136,194 L137,195 L136,196 Z',
    'Maharashtra': 'M145,205 L152,204 L159,206 L166,209 L172,214 L177,220 L180,227 L182,234 L182,241 L180,247 L177,252 L172,256 L166,259 L159,260 L152,260 L145,258 L139,255 L134,250 L130,244 L128,237 L127,230 L128,223 L130,216 L134,210 L139,207 Z',
    'Telangana': 'M183,240 L188,239 L193,240 L197,242 L200,245 L202,249 L203,253 L202,257 L200,260 L197,262 L193,263 L188,263 L184,261 L181,258 L179,254 L178,250 L179,246 L181,243 Z',
    'Andhra Pradesh': 'M195,264 L202,263 L209,265 L215,268 L220,273 L223,279 L225,286 L225,293 L223,299 L220,304 L215,308 L209,310 L202,311 L196,310 L190,307 L185,302 L182,296 L180,289 L180,282 L182,275 L185,270 L190,267 Z',
    'Karnataka': 'M152,262 L159,261 L166,263 L172,266 L177,271 L181,277 L183,284 L184,291 L183,298 L181,304 L177,309 L172,313 L166,315 L159,316 L153,315 L147,312 L142,307 L138,301 L136,294 L136,287 L138,280 L142,274 L147,269 Z',
    'Goa': 'M145,257 L148,256 L151,257 L153,259 L154,262 L153,265 L151,267 L148,268 L145,267 L143,265 L142,262 L143,259 Z',
    'Kerala': 'M148,317 L153,316 L158,318 L161,321 L163,325 L164,330 L163,335 L161,339 L158,342 L153,344 L149,344 L144,342 L140,338 L137,333 L135,328 L135,323 L137,318 L140,315 L144,314 Z',
    'Tamil Nadu': 'M160,318 L167,317 L174,319 L180,323 L185,328 L188,334 L190,341 L190,348 L188,354 L185,359 L180,363 L174,365 L167,366 L161,365 L155,362 L150,357 L147,351 L145,344 L145,337 L147,330 L150,324 L155,320 Z',
    'Puducherry': 'M172,348 L173,347 L174,348 L173,349 Z',
    'Lakshadweep': 'M95,310 L97,309 L99,310 L100,312 L100,314 L99,316 L97,317 L95,316 L94,314 L94,312 Z',
    'Andaman and Nicobar Islands': 'M305,340 L308,338 L311,340 L312,343 L312,347 L311,350 L308,352 L305,351 L303,348 L303,343 Z'
  };

  function renderIndiaMap(rows){
    const stateCounts = new Map();
    for(const r of rows){
      const st = trim(r.State);
      if(st) stateCounts.set(st, (stateCounts.get(st)||0)+1);
    }
    
    const maxCount = Math.max(...stateCounts.values(), 1);
    const svg = document.getElementById('indiaMap');
    const tooltip = document.getElementById('mapTooltip');
    
    svg.innerHTML = '';
    
    for(const [state, path] of Object.entries(stateCoords)){
      const count = stateCounts.get(state) || 0;
      const intensity = count / maxCount;
      let fillColor = '#f1f5f9';
      if(intensity > 0.75) fillColor = '#15803d';
      else if(intensity > 0.5) fillColor = '#22c55e';
      else if(intensity > 0.25) fillColor = '#86efac';
      else if(intensity > 0) fillColor = '#dcfce7';
      
      const pathEl = document.createElementNS('http://www.w3.org/2000/svg', 'path');
      pathEl.setAttribute('d', path);
      pathEl.setAttribute('fill', fillColor);
      pathEl.setAttribute('class', 'state-region');
      pathEl.setAttribute('data-state', state);
      pathEl.setAttribute('data-count', count);
      
      pathEl.addEventListener('mouseenter', (e)=>{
        tooltip.textContent = `${state}: ${count.toLocaleString()} scans`;
        tooltip.style.display = 'block';
      });
      
      pathEl.addEventListener('mousemove', (e)=>{
        const rect = document.getElementById('indiaMapContainer').getBoundingClientRect();
        tooltip.style.left = (e.clientX - rect.left + 15) + 'px';
        tooltip.style.top = (e.clientY - rect.top - 40) + 'px';
      });
      
      pathEl.addEventListener('mouseleave', ()=>{
        tooltip.style.display = 'none';
      });
      
      pathEl.addEventListener('click', ()=>{
        FILTERS.state = state;
        selState.value = state;
        render();
      });
      
      svg.appendChild(pathEl);
    }
  }

  function populateFilters(rows){
    const states = uniqSorted(rows.map(r=>trim(r.State)));
    const dists  = uniqSorted(rows.map(r=>trim(r.District)));
    const rets   = uniqSorted(rows.map(r=>trim(r['Retailer Name'])));
    const products = uniqSorted(rows.flatMap(r=>[...parseProducts(r['Cart Items']).keys()]));
    const statuses = ['','Yes','No','Pending'];

    function fill(sel, items){ 
      sel.innerHTML = ''; 
      const opt0 = document.createElement('option'); 
      opt0.value=''; 
      opt0.textContent='All'; 
      sel.appendChild(opt0); 
      for(const v of items){ 
        const o=document.createElement('option'); 
        o.value=v; 
        o.textContent=v; 
        sel.appendChild(o);
      } 
    }
    fill(selState, states); 
    fill(selDistrict, dists); 
    fill(selRetailer, rets); 
    fill(selProduct, products);
    fill(selStatus, statuses);
  }

  function attachFilterHandlers(){
    selDateFrom.onchange = ()=>{ FILTERS.dateFrom = selDateFrom.value; render(); };
    selDateTo.onchange = ()=>{ FILTERS.dateTo = selDateTo.value; render(); };
    selState.onchange = ()=>{ FILTERS.state = selState.value; render(); };
    selDistrict.onchange = ()=>{ FILTERS.district = selDistrict.value; render(); };
    selRetailer.onchange = ()=>{ FILTERS.retailer = selRetailer.value; render(); };
    selProduct.onchange = ()=>{ FILTERS.product = selProduct.value; render(); };
    selStatus.onchange = ()=>{ FILTERS.status = selStatus.value; render(); };
    let to=null; 
    inpQtyMin.oninput = ()=>{ 
      clearTimeout(to); 
      to=setTimeout(()=>{ FILTERS.qtyMin = Number(inpQtyMin.value||0); render(); }, 300); 
    };
  }

  function render(){
    const rows = applyFilters(RAW);
    updateKpis(rows);
    renderStatesTable(rows);
    renderIndiaMap(rows);
    requestAnimationFrame(()=> renderCharts(rows));
  }

  // Load CSV
  function normalizeRow(r){
    const obj = {
      'User ID': r['User ID']||r['UserID']||r['id']||'',
      'Phone Number': r['Phone Number']||r['Phone']||r['phone']||'',
      'First Name': r['First Name']||r['FirstName']||'',
      'Last Name': r['Last Name']||r['LastName']||'',
      'District': r['District']||'',
      'State': r['State']||'',
      'Language': r['Language']||'',
      'Pin Code': r['Pin Code']||r['Pincode']||'',
      'QR Code': r['QR Code']||'',
      'Land Acreage': r['Land Acreage']||r['Land']||'',
      'Crop Name': r['Crop Name']||'',
      'Scan Date': r['Scan Date']||r['Date']||'',
      'RIN': r['RIN']||'',
      'Retailer Name': r['Retailer Name']||r['Retailer']||'',
      'Cart Items': r['Cart Items']||'',
      'Coupon Code': r['Coupon Code']||'',
      'Submission Status': r['Submission Status']||r['Approved Status']||''
    };
    return obj;
  }

  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    dynamicTyping: false,
    complete: (res)=>{
      RAW = res.data.map(normalizeRow);
      populateFilters(RAW);
      attachFilterHandlers();
      render();
    },
    error: (err)=>{
      console.error('CSV load error', err);
      alert('Failed to load data.csv. Ensure the file exists at '+CSV_URL);
    }
  });
</script>
</body>
</html>
