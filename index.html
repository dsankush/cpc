<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digicides • Campaign Analytics (Fast)</title>
  <!-- TailwindCSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Day.js for dates -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.11/dayjs.min.js"></script>
  <!-- XLSX for Excel downloads -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      /* Calm, performance-friendly theme */
      --bg: #0d1117;        /* dark slate */
      --card: #111827;      /* deep gray */
      --muted: #9aa4b2;     /* cool gray */
      --text: #e5eefb;      /* near-white */
      --accent: #22d3ee;    /* cyan */
      --accent2: #34d399;   /* emerald */
      --border: #1f2937;    /* soft border */
    }
    html, body { background: var(--bg); color: var(--text); font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; }
    .btn-primary { background: linear-gradient(90deg, var(--accent), var(--accent2)); color:#00131a; font-weight:700; border-radius:10px; }
    .btn-ghost { background: transparent; border: 1px solid var(--border); color: var(--text); border-radius:10px; }
    .chip { background: #0f1624; border: 1px solid var(--border); color: var(--muted); border-radius: 999px; padding: 6px 12px; }

    .grid-kpi { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px,1fr)); gap: 12px; }
    .grid-charts { display:grid; grid-template-columns: repeat(auto-fit, minmax(360px,1fr)); gap: 16px; }

    .chart-wrap { height: 260px; padding: 10px; }
    .chart-wrap.tall { height: 320px; }
    .chart-wrap canvas { width:100% !important; height:100% !important; background:#0b1322; border-radius:10px; }

    .login-bg { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#0b1220; z-index:50; }
    .sticky { position: sticky; top: 12px; align-self: start; }

    .input, select { background:#0b1322; border:1px solid var(--border); border-radius:10px; color:var(--text); padding:8px 10px; width:100%; }
    .label { font-size:12px; color: var(--muted); }

    .table-wrapper { max-height: 360px; overflow:auto; border:1px solid var(--border); border-radius:10px; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid var(--border); padding: 8px 10px; text-align:left; }
    th { position: sticky; top:0; background:#0e1627; z-index:1; }

    .tab { padding: 8px 12px; border-radius: 10px; cursor: pointer; border:1px solid var(--border); color:var(--muted); }
    .tab.active { color: var(--text); border-color: var(--accent); }

    .toast { position: fixed; right:16px; bottom:16px; background:#0e1627; border:1px solid var(--border); border-radius:10px; padding:10px 14px; display:none; z-index:60 }
  </style>
</head>
<body>
  <!-- LOGIN OVERLAY -->
  <div id="loginOverlay" class="login-bg">
    <div class="card p-6 w-full max-w-md">
      <h1 class="text-xl font-bold mb-4" style="color:var(--accent)">Digicides • Campaign Dashboard</h1>
      <form id="loginForm" class="space-y-3" autocomplete="off">
        <input id="username" class="input" placeholder="Username" />
        <input id="password" type="password" class="input" placeholder="Password" />
        <button class="btn-primary w-full py-2" type="submit">Login</button>
        <p id="loginErr" class="hidden text-red-400 text-sm">Invalid credentials.</p>
        <p class="text-xs" style="color:var(--muted)">Hint: digicides / coromandel@cpc</p>
      </form>
    </div>
  </div>

  <!-- HEADER -->
  <header class="px-5 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-2.5 h-6 rounded" style="background:linear-gradient(180deg,var(--accent),var(--accent2))"></div>
      <h1 class="text-lg font-bold">Coromandel Campaign Insights</h1>
    </div>
    <nav class="flex gap-2">
      <button id="tabDashboard" class="tab active">Dashboard</button>
      <button id="tabDownloads" class="tab">Downloads</button>
      <button id="refreshBtn" class="chip"><span>Refresh</span></button>
    </nav>
  </header>

  <!-- MAIN -->
  <main class="px-5 grid grid-cols-1 xl:grid-cols-[1fr_320px] gap-5 pb-16">
    <!-- LEFT: Dashboard / Downloads -->
    <section id="viewDashboard">
      <!-- KPIs -->
      <div class="grid-kpi">
        <div class="card p-4"><p class="text-xs" style="color:var(--muted)">Total Scans</p><p id="kpiTotal" class="text-2xl font-bold">0</p></div>
        <div class="card p-4"><p class="text-xs" style="color:var(--muted)">Approved (Yes)</p><p id="kpiYes" class="text-2xl font-bold">0</p></div>
        <div class="card p-4"><p class="text-xs" style="color:var(--muted)">Pending</p><p id="kpiPending" class="text-2xl font-bold">0</p></div>
        <div class="card p-4"><p class="text-xs" style="color:var(--muted)">Completion Rate</p><p id="kpiRate" class="text-2xl font-bold">0%</p></div>
      </div>

      <!-- CHARTS -->
      <section class="grid-charts mt-5">
        <div class="card p-4"><h3 class="font-semibold mb-2">Approved Status (Yes / No / Pending)</h3><div class="chart-wrap"><canvas id="statusChart"></canvas></div></div>
        <div class="card p-4"><h3 class="font-semibold mb-2">Retailer Performance (Top 10)</h3><div class="chart-wrap"><canvas id="retailerChart"></canvas></div></div>
        <div class="card p-4"><h3 class="font-semibold mb-2">District-wise Scans (Top 10)</h3><div class="chart-wrap"><canvas id="districtChart"></canvas></div></div>
        <div class="card p-4"><h3 class="font-semibold mb-2">State-wise Scans</h3><div class="chart-wrap"><canvas id="stateChart"></canvas></div></div>
        <div class="card p-4"><h3 class="font-semibold mb-2">Top Products (by Quantity)</h3><div class="chart-wrap"><canvas id="productChart"></canvas></div></div>
        <div class="card p-4 xl:col-span-2"><h3 class="font-semibold mb-2">Time Trend (Scans per Hour)</h3><div class="chart-wrap tall"><canvas id="timeChart"></canvas></div></div>
      </section>

      <!-- TABLE -->
      <section class="mt-5">
        <div class="card p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Records (first 500 rows)</h3>
            <div class="flex gap-2 items-center">
              <input id="searchBox" placeholder="Search…" class="input w-56"/>
              <button id="exportBtn" class="chip">Export Filtered CSV</button>
            </div>
          </div>
          <div class="table-wrapper"><table id="dataTable"><thead></thead><tbody></tbody></table></div>
        </div>
      </section>
    </section>

    <!-- DOWNLOADS PAGE -->
    <section id="viewDownloads" class="hidden">
      <div class="card p-6">
        <h2 class="font-semibold text-lg mb-1">Downloads</h2>
        <p class="text-sm mb-4" style="color:var(--muted)">Export your data and KPIs. Filters apply to the filtered exports.</p>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <button id="dlFullXLSX" class="btn-primary py-2">Full data (.xlsx)</button>
          <button id="dlFilteredXLSX" class="btn-ghost py-2">Filtered data (.xlsx)</button>
          <button id="dlFilteredCSV" class="btn-ghost py-2">Filtered data (.csv)</button>
          <button id="dlKPIsXLSX" class="btn-ghost py-2">KPI summary (.xlsx)</button>
          <button id="dlCharts" class="btn-ghost py-2">Download all charts (PNG)</button>
          <label class="btn-ghost py-2 text-center cursor-pointer" for="csvInput">Upload CSV (fallback)</label>
        </div>
      </div>
    </section>

    <!-- RIGHT: FILTERS (Manual apply for speed) -->
    <aside class="card p-4 sticky">
      <h3 class="font-semibold mb-3">Filters</h3>
      <div class="space-y-3">
        <div><div class="label">State</div><select id="stateFilter" class="input"></select></div>
        <div><div class="label">District</div><select id="districtFilter" class="input"></select></div>
        <div><div class="label">Retailer</div><select id="retailerFilter" class="input"></select></div>
        <div><div class="label">Crop</div><select id="cropFilter" class="input"></select></div>
        <div><div class="label">Language</div><select id="languageFilter" class="input"></select></div>
        <div><div class="label">Status</div>
          <select id="statusFilter" class="input">
            <option value="">All</option>
            <option value="Yes">Yes</option>
            <option value="No">No</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
        <div><div class="label">Product</div><select id="productFilter" class="input"></select></div>
        <div>
          <div class="label">Qty (sum per row)</div>
          <div class="grid grid-cols-2 gap-2">
            <input id="qtyMin" type="number" class="input" placeholder="Min" />
            <input id="qtyMax" type="number" class="input" placeholder="Max" />
          </div>
        </div>
        <div class="flex gap-2 pt-1">
          <button id="applyFilters" class="btn-primary px-3 py-2">Apply</button>
          <button id="clearFilters" class="chip">Clear</button>
        </div>
      </div>
    </aside>
  </main>

  <div id="toast" class="toast"></div>

<script>
/******************** CONFIG ********************/
const CSV_URL_DEFAULT = 'https://github.com/dsankush/cpc/blob/main/data.csv'; // we will auto-convert to RAW
const REQUIRE_LOGIN = true;
const AUTO_REFRESH_MS = 0; // set to 300000 for 5 min refresh if needed

/******************** LOGIN ********************/
(function auth(){
  const ok = sessionStorage.getItem('digicides_auth_ok');
  if(REQUIRE_LOGIN && ok!=='1'){
    document.getElementById('loginOverlay').style.display = 'flex';
    document.getElementById('loginForm').addEventListener('submit', (e)=>{
      e.preventDefault(); const u=username.value.trim(); const p=password.value.trim();
      if(u==='digicides' && p==='coromandel@cpc'){ sessionStorage.setItem('digicides_auth_ok','1'); loginOverlay.style.display='none'; initApp(); }
      else loginErr.classList.remove('hidden');
    });
  } else { document.getElementById('loginOverlay').style.display='none'; initApp(); }
})();

/******************** STATE ********************/
let rows=[], rawRows=[]; let productsMaster=new Set(); let charts={};
const columnsOrder=['User ID','Phone Number','First Name','Last Name','District','State','Language','Pin Code','QR Code','Land Acreage','Crop Name','Scan Date','RIN','Retailer Name','Cart Items','Coupon Code','Submission Status'];

/******************** UTILS ********************/
function toast(msg, err=false){ const t=toastEl; t.textContent=msg; t.style.display='block'; t.style.borderColor=err?'#f87171':'#1f2937'; clearTimeout(t.__hide); t.__hide=setTimeout(()=>t.style.display='none', 3200); }
const toastEl = document.getElementById('toast');
function toNumber(x){ if(x==null||x==='') return null; const n=Number(String(x).replace(/,/g,'').trim()); return Number.isFinite(n)?n:null; }
function norm(x){ return (x==null?'':String(x)).trim(); }
function parseDateSmart(s){ if(!s) return null; const str=String(s).trim(); let d=dayjs(str); if(!d.isValid()){ const m=str.match(/(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/); if(m){ const [_,dd,MM,yyyy,hh,mm,ss]=m; const iso=`${yyyy}-${MM}-${dd}${hh?` ${hh}:${mm||'00'}:${ss||'00'}`:''}`; d=dayjs(iso);} } return d.isValid()?d:null; }
function parseCartItems(cart){ const out=[]; if(!cart) return out; String(cart).split(/\s*,\s*/).forEach(p=>{ const m=p.match(/^(.+?)\s*-\s*qty\s*(\d+)\s*-\s*([\w.]+)$/i); if(m){ out.push({name:m[1].trim(), qty:Number(m[2]), size:m[3].trim()}); } else if(p){ out.push({name:p.trim(), qty:1, size:''}); } }); return out; }
function uniqueSorted(arr){ return Array.from(new Set(arr)).filter(Boolean).sort((a,b)=> String(a).localeCompare(String(b)); }
function normalizeGithubUrl(u){ try{ const url=new URL(u); if(url.hostname==='github.com'){ const parts=url.pathname.split('/').filter(Boolean); const i=parts.indexOf('blob'); if(i>-1){ return `https://raw.githubusercontent.com/${parts[0]}/${parts[1]}/${parts[i+1]}/${parts.slice(i+2).join('/')}`; } return u+(url.search? '&':'?')+'raw=1'; } return u; } catch{ return u; } }

/******************** FILTERS ********************/
function buildFilters(){
  const states=uniqueSorted(rows.map(r=>r.State));
  const dists=uniqueSorted(rows.map(r=>r.District));
  const rets=uniqueSorted(rows.map(r=>r['Retailer Name']));
  const crops=uniqueSorted(rows.flatMap(r=> String(r['Crop Name']||'').split(/\s*,\s*/)));
  const langs=uniqueSorted(rows.map(r=> r.Language));
  const prods=uniqueSorted(Array.from(productsMaster));
  function fill(el, arr){ el.innerHTML = `<option value="">All</option>` + arr.map(v=>`<option>${v}</option>`).join(''); }
  fill(stateFilter, states); fill(districtFilter, dists); fill(retailerFilter, rets); fill(cropFilter, crops); fill(languageFilter, langs); fill(productFilter, prods);
}

function filteredRows(){
  const fs={ state:norm(stateFilter.value), district:norm(districtFilter.value), retailer:norm(retailerFilter.value), crop:norm(cropFilter.value), language:norm(languageFilter.value), status:norm(statusFilter.value), product:norm(productFilter.value), qtyMin:toNumber(qtyMin.value), qtyMax:toNumber(qtyMax.value), search:norm(searchBox.value).toLowerCase() };
  return rows.filter(r=>{
    if(fs.state && r.State!==fs.state) return false;
    if(fs.district && r.District!==fs.district) return false;
    if(fs.retailer && r['Retailer Name']!==fs.retailer) return false;
    if(fs.language && r.Language!==fs.language) return false;
    if(fs.status){ const st=norm(r['Submission Status'])||''; const m = (st==='Yes'||st==='Pending')?st:'No'; if(m!==fs.status) return false; }
    if(fs.crop){ const list=String(r['Crop Name']||'').split(/\s*,\s*/); if(!list.includes(fs.crop)) return false; }
    if(fs.product){ const ok=(r._cartParsed||[]).some(ci=>ci.name===fs.product); if(!ok) return false; }
    if(fs.qtyMin!=null || fs.qtyMax!=null){ let q=0; if(fs.product){ q=(r._cartParsed||[]).filter(ci=>ci.name===fs.product).reduce((a,b)=>a+(b.qty||0),0);} else { q=(r._cartParsed||[]).reduce((a,b)=>a+(b.qty||0),0);} if(fs.qtyMin!=null && q<fs.qtyMin) return false; if(fs.qtyMax!=null && q>fs.qtyMax) return false; }
    if(fs.search){ const hay=columnsOrder.map(c=>String(r[c]||'')).join('|').toLowerCase(); if(!hay.includes(fs.search)) return false; }
    return true;
  });
}

/******************** CHARTS (fast) ********************/
Chart.defaults.color = '#d7e2f0';
Chart.defaults.font.family = 'Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';
Chart.defaults.animation = false; // speed
Chart.defaults.responsive = true;

function destroyChart(id){ if(charts[id]){ charts[id].destroy(); delete charts[id]; } }
function makeDoughnut(id, labels, data){ destroyChart(id); charts[id]=new Chart(document.getElementById(id),{ type:'doughnut', data:{ labels, datasets:[{ data, borderWidth:1.2 }]}, options:{ maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#bcd' } } } } }); }
function makeBar(id, labels, data, horizontal=false){ destroyChart(id); charts[id]=new Chart(document.getElementById(id),{ type:'bar', data:{ labels, datasets:[{ data, borderWidth:1.2 }]}, options:{ indexAxis: horizontal?'y':'x', maintainAspectRatio:false, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#bcd', autoSkip:true, maxRotation:0 } }, y:{ ticks:{ color:'#bcd' } } } } }); }
function makeLine(id, labels, data){ destroyChart(id); charts[id]=new Chart(document.getElementById(id),{ type:'line', data:{ labels, datasets:[{ data, tension:0.35, borderWidth:2, fill:false }]}, options:{ maintainAspectRatio:false, parsing:false, normalized:true, plugins:{ legend:{ labels:{ color:'#bcd' } } }, scales:{ x:{ ticks:{ color:'#bcd', autoSkip:true, maxRotation:0 } }, y:{ ticks:{ color:'#bcd' } } } } }); }

function computeAggregations(list){
  const agg = { status:{}, retailer:{}, district:{}, state:{}, product:{}, time:{} };
  for(const r of list){
    // Approved status: Yes/No/Pending (map other to No)
    const stRaw = norm(r['Submission Status'])||''; const st = (stRaw==='Yes'||stRaw==='Pending')?stRaw:'No';
    agg.status[st]=(agg.status[st]||0)+1;
    const ret = norm(r['Retailer Name'])||'(blank)'; agg.retailer[ret]=(agg.retailer[ret]||0)+1;
    const dist = norm(r.District)||'(blank)'; agg.district[dist]=(agg.district[dist]||0)+1;
    const stt = norm(r.State)||'(blank)'; agg.state[stt]=(agg.state[stt]||0)+1;
    (r._cartParsed||[]).forEach(ci=>{ agg.product[ci.name]=(agg.product[ci.name]||0)+(ci.qty||0); });
    const d=parseDateSmart(r['Scan Date']); if(d){ const k=d.format('YYYY-MM-DD HH:00'); agg.time[k]=(agg.time[k]||0)+1; }
  }
  return agg;
}

function updateCharts(list){
  const a = computeAggregations(list);
  // 1 Approved Status
  const statusOrder=['Yes','No','Pending']; makeDoughnut('statusChart', statusOrder, statusOrder.map(k=>a.status[k]||0));
  // 2 Retailer top 10
  const rTop = Object.entries(a.retailer).sort((x,y)=>y[1]-x[1]).slice(0,10); makeBar('retailerChart', rTop.map(x=>x[0]), rTop.map(x=>x[1]));
  // 3 District top 10 (horizontal)
  const dTop = Object.entries(a.district).sort((x,y)=>y[1]-x[1]).slice(0,10); makeBar('districtChart', dTop.map(x=>x[0]), dTop.map(x=>x[1]), true);
  // 4 State scans (sorted desc)
  const sTop = Object.entries(a.state).sort((x,y)=>y[1]-x[1]); makeBar('stateChart', sTop.map(x=>x[0]), sTop.map(x=>x[1]), true);
  // 5 Top products (top 5 quantities)
  const pTop = Object.entries(a.product).sort((x,y)=>y[1]-x[1]).slice(0,5); makeBar('productChart', pTop.map(x=>x[0]), pTop.map(x=>x[1]), true);
  // 6 Time trend
  const ts = Object.entries(a.time).sort((a,b)=> a[0].localeCompare(b[0])); makeLine('timeChart', ts.map(x=>x[0]), ts.map(x=>x[1]));
}

/******************** KPIs & TABLE ********************/
function updateKPIs(list){ const total=list.length; const yes=list.filter(r=> (norm(r['Submission Status'])==='Yes')).length; const pending=list.filter(r=> norm(r['Submission Status'])==='Pending').length; const rate= total? Math.round(yes/total*100):0; kpiTotal.textContent=total; kpiYes.textContent=yes; kpiPending.textContent=pending; kpiRate.textContent=rate+'%'; }

function renderTable(list){ const thead=document.querySelector('#dataTable thead'); const tbody=document.querySelector('#dataTable tbody'); thead.innerHTML='<tr>'+columnsOrder.map(c=>`<th>${c}</th>`).join('')+'<th>Parsed Products</th></tr>'; const max=500; const slice=list.slice(0,max); tbody.innerHTML = slice.map(r=>{ const tds=columnsOrder.map(c=>`<td>${r[c]??''}</td>`).join(''); const parsed=(r._cartParsed||[]).map(ci=>`${ci.name} (qty ${ci.qty}${ci.size?', '+ci.size:''})`).join(', '); return `<tr>${tds}<td>${parsed}</td></tr>`; }).join(''); }

/******************** EXPORTS ********************/
function exportCSV(list){ const out=list.map(r=>{ const o=Object.fromEntries(columnsOrder.map(c=>[c, r[c]??''])); o['Parsed Product Names']=(r._cartParsed||[]).map(ci=>ci.name).join('|'); o['Parsed Total Qty']=(r._cartParsed||[]).reduce((a,b)=>a+(b.qty||0),0); return o; }); const csv=Papa.unparse(out); const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='filtered_export.csv'; a.click(); URL.revokeObjectURL(url); }
function exportXLSX(list, filename){ const out=list.map(r=>{ const o=Object.fromEntries(columnsOrder.map(c=>[c, r[c]??''])); o['Parsed Product Names']=(r._cartParsed||[]).map(ci=>ci.name).join('|'); o['Parsed Total Qty']=(r._cartParsed||[]).reduce((a,b)=>a+(b.qty||0),0); return o; }); const ws=XLSX.utils.json_to_sheet(out); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Data'); XLSX.writeFile(wb, filename); }
function exportKPIsXLSX(){ const list=filteredRows(); const total=list.length; const yes=list.filter(r=>norm(r['Submission Status'])==='Yes').length; const pending=list.filter(r=>norm(r['Submission Status'])==='Pending').length; const no=list.filter(r=>{ const st=norm(r['Submission Status']); return !(st==='Yes'||st==='Pending');}).length; const rate=total?Math.round(yes/total*100):0; const rows=[{Metric:'Total Scans', Value:total},{Metric:'Yes', Value:yes},{Metric:'No', Value:no},{Metric:'Pending', Value:pending},{Metric:'Completion Rate %', Value:rate}]; const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'KPIs'); XLSX.writeFile(wb, 'kpis_summary.xlsx'); }
function downloadAllCharts(){ for(const [id,chart] of Object.entries(charts)){ const link=document.createElement('a'); link.href=chart.toBase64Image(); link.download=`${id}.png`; document.body.appendChild(link); link.click(); document.body.removeChild(link); } }

/******************** WIRING ********************/
function rebuild(){ const list=filteredRows(); updateKPIs(list); updateCharts(list); renderTable(list); }

// Manual apply (for performance)
applyFilters.addEventListener('click', rebuild);
clearFilters.addEventListener('click', ()=>{ ['stateFilter','districtFilter','retailerFilter','cropFilter','languageFilter','statusFilter','productFilter','qtyMin','qtyMax','searchBox'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }); rebuild(); });

refreshBtn.addEventListener('click', ()=> fetchData(true));
exportBtn.addEventListener('click', ()=> exportCSV(filteredRows()));

// Tabs
const viewDashboard = document.getElementById('viewDashboard');
const viewDownloads = document.getElementById('viewDownloads');
function showTab(tab){ if(tab==='downloads'){ viewDashboard.classList.add('hidden'); viewDownloads.classList.remove('hidden'); tabDownloads.classList.add('active'); tabDashboard.classList.remove('active'); } else { viewDashboard.classList.remove('hidden'); viewDownloads.classList.add('hidden'); tabDashboard.classList.add('active'); tabDownloads.classList.remove('active'); } }

tabDashboard.addEventListener('click', ()=> showTab('dashboard'));
tabDownloads.addEventListener('click', ()=> showTab('downloads'));

// Downloads buttons (Excel/CSV/Charts)
dlFullXLSX.addEventListener('click', ()=> exportXLSX(rows, 'full_data.xlsx'));
dlFilteredXLSX.addEventListener('click', ()=> exportXLSX(filteredRows(), 'filtered_data.xlsx'));
dlFilteredCSV.addEventListener('click', ()=> exportCSV(filteredRows()));
dlKPIsXLSX.addEventListener('click', exportKPIsXLSX);
dlCharts.addEventListener('click', downloadAllCharts);

// CSV file fallback
csvInput.addEventListener('change', (e)=>{ const file=e.target.files?.[0]; if(!file) return; Papa.parse(file,{header:true,skipEmptyLines:true,complete:(res)=>{ normalizeAndParse(res.data); toast('Loaded from file'); }, error:(err)=> toast('CSV parse error: '+err, true)}); });

// Search debounce
searchBox.addEventListener('input', ()=>{ clearTimeout(window.__sb); window.__sb=setTimeout(rebuild, 180); });

/******************** DATA LOAD ********************/
function normalizeAndParse(data){ productsMaster=new Set(); rows=data.map(r=>{ const o={}; columnsOrder.forEach(c=> o[c]= r[c]!==undefined? r[c]:'' ); o['Land Acreage']=toNumber(o['Land Acreage']); o._scanDate=parseDateSmart(o['Scan Date']); o._cartParsed=parseCartItems(o['Cart Items']); (o._cartParsed||[]).forEach(ci=> productsMaster.add(ci.name)); return o; }); buildFilters(); rebuild(); }

function csvUrlFromQuery(){ const u=new URL(location.href); const q=u.searchParams.get('csv'); return q?normalizeGithubUrl(decodeURIComponent(q)):normalizeGithubUrl(CSV_URL_DEFAULT); }

async function fetchData(isManual=false){ try{ const url=csvUrlFromQuery(); const res=await fetch(url, { cache:'no-store' }); if(!res.ok) throw new Error('HTTP '+res.status+' for '+url); const text=await res.text(); const parsed=Papa.parse(text, { header:true, skipEmptyLines:true }); if(parsed.errors && parsed.errors.length){ console.warn('CSV parse errors', parsed.errors.slice(0,3)); }
  rawRows=parsed.data; if(!rawRows || !rawRows.length){ throw new Error('No rows in CSV'); }
  normalizeAndParse(rawRows); toast((isManual?'Refreshed':'Loaded')+' from CSV');
 } catch(err){ console.error(err); toast('Failed to load CSV. Use Upload CSV (fallback).', true); }
}

function initApp(){ fetchData(false); if(AUTO_REFRESH_MS>0){ setInterval(()=>fetchData(), AUTO_REFRESH_MS); } }
</script>
</body>
</html>
