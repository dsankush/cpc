<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digicides • Campaign Analytics</title>
  <!-- TailwindCSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Day.js for dates -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.11/dayjs.min.js"></script>

  <style>
    :root{
      --bg: #0b0f19; --panel: #101528; --accent: #9bff57; --accent2: #6ce1ff; --text: #e8eef9; --muted: #98a2b3; --chip: #1a2140; --chip-active: #2a345d;
    }
    html, body { background: #070a12; color: var(--text); font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .glass { background: rgba(255,255,255,0.04); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; }
    .btn { background: linear-gradient(90deg, var(--accent), var(--accent2)); color:#00131a; font-weight:700; transition: all .2s; }
    .btn:hover { filter: brightness(1.06); }
    .chip { background: var(--chip); padding: 6px 12px; border-radius: 999px; cursor: pointer; color: var(--muted); border: 1px solid rgba(255,255,255,0.08) }
    .chip.active { background: var(--chip-active); color: var(--text); }
    .grid-cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 14px; }
    .chart-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(360px,1fr)); gap:18px; }
    canvas { background: #0c1224; border-radius: 12px; padding: 8px; }
    .neon-title { font-weight: 800; letter-spacing: .5px; background: linear-gradient(90deg, var(--accent), var(--accent2)); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .login-bg { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#05070f; z-index:50; }
    .table-wrapper { max-height: 360px; overflow:auto; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid rgba(255,255,255,0.06); padding: 8px 10px; }
    th { position: sticky; top:0; background: #0f1630; text-align:left; z-index: 1; }
    .toast { position: fixed; right: 16px; bottom: 16px; background: #0f1630; border: 1px solid rgba(255,255,255,0.12); padding: 10px 14px; border-radius: 12px; display:none }
  </style>
</head>
<body>
  <!-- LOGIN OVERLAY (kept) -->
  <div id="loginOverlay" class="login-bg">
    <div class="glass p-8 w-full max-w-md">
      <h1 class="text-2xl neon-title mb-4">Digicides • Campaign Dashboard</h1>
      <form id="loginForm" class="space-y-4" autocomplete="off">
        <input id="username" class="w-full px-3 py-2 rounded bg-[#0a1022] border border-slate-700" placeholder="Username" />
        <input id="password" type="password" class="w-full px-3 py-2 rounded bg-[#0a1022] border border-slate-700" placeholder="Password" />
        <button class="btn w-full py-2 rounded" type="submit">Login</button>
        <p id="loginErr" class="hidden text-red-400 text-sm">Invalid credentials.</p>
        <p class="text-xs text-slate-400 mt-2">Hint: digicides / coromandel@cpc</p>
      </form>
    </div>
  </div>

  <header class="p-5 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <i class="fa-solid fa-seedling text-xl" style="color:var(--accent)"></i>
      <h1 class="text-xl neon-title">Coromandel Campaign Insights</h1>
    </div>
    <div class="flex items-center gap-2">
      <button id="refreshBtn" class="chip"><i class="fa-solid fa-rotate mr-2"></i>Refresh</button>
      <label class="chip" for="csvInput"><i class="fa-solid fa-file-arrow-up mr-2"></i>Upload CSV (fallback)</label>
      <input id="csvInput" type="file" accept=".csv" class="hidden" />
    </div>
  </header>

  <!-- FILTERS -->
  <section class="px-5">
    <div class="glass p-4">
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-3">
        <div>
          <label class="text-xs text-slate-300">State</label>
          <select id="stateFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700"></select>
        </div>
        <div>
          <label class="text-xs text-slate-300">District</label>
          <select id="districtFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700"></select>
        </div>
        <div>
          <label class="text-xs text-slate-300">Retailer</label>
          <select id="retailerFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700"></select>
        </div>
        <div>
          <label class="text-xs text-slate-300">Crop</label>
          <select id="cropFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700"></select>
        </div>
        <div>
          <label class="text-xs text-slate-300">Submission</label>
          <select id="statusFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700">
            <option value="">All</option>
            <option value="Yes">Yes</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-slate-300">Product</label>
          <select id="productFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700"></select>
        </div>
        <div>
          <label class="text-xs text-slate-300">Min Qty</label>
          <input id="qtyMin" type="number" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700" placeholder="0" />
        </div>
        <div>
          <label class="text-xs text-slate-300">Max Qty</label>
          <input id="qtyMax" type="number" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700" placeholder="" />
        </div>
      </div>
      <div class="flex flex-wrap gap-2 mt-3 items-center">
        <input id="searchBox" placeholder="Search…" class="px-3 py-2 rounded bg-[#0a1022] border border-slate-700"/>
        <button id="applyFilters" class="btn px-4 py-2 rounded-xl"><i class="fa-solid fa-filter mr-2"></i>Apply</button>
        <button id="clearFilters" class="chip"><i class="fa-solid fa-broom mr-2"></i>Clear</button>
        <button id="exportBtn" class="chip"><i class="fa-solid fa-file-csv mr-2"></i>Export Filtered CSV</button>
      </div>
    </div>
  </section>

  <!-- KPI CARDS -->
  <section class="px-5 mt-5">
    <div class="grid-cards">
      <div class="glass p-4"><p class="text-xs">Total Scans</p><p id="kpiTotal" class="text-2xl font-bold">0</p></div>
      <div class="glass p-4"><p class="text-xs">Completed (Yes)</p><p id="kpiYes" class="text-2xl font-bold">0</p></div>
      <div class="glass p-4"><p class="text-xs">Pending</p><p id="kpiPending" class="text-2xl font-bold">0</p></div>
      <div class="glass p-4"><p class="text-xs">Completion Rate</p><p id="kpiRate" class="text-2xl font-bold">0%</p></div>
    </div>
  </section>

  <!-- CHARTS -->
  <section class="px-5 mt-6 chart-grid">
    <div class="glass p-4"><h3 class="font-semibold mb-2">1) Submission Status</h3><canvas id="statusChart" height="160"></canvas></div>
    <div class="glass p-4"><h3 class="font-semibold mb-2">2) Retailer Performance</h3><canvas id="retailerChart" height="160"></canvas></div>
    <div class="glass p-4"><h3 class="font-semibold mb-2">3) Crop-wise Registrations</h3><canvas id="cropChart" height="160"></canvas></div>
    <div class="glass p-4"><h3 class="font-semibold mb-2">4) Top Products</h3><canvas id="productChart" height="160"></canvas></div>
    <div class="glass p-4"><h3 class="font-semibold mb-2">5) District/State Activity</h3><canvas id="regionChart" height="160"></canvas></div>
    <div class="glass p-4"><h3 class="font-semibold mb-2">6) Avg Land by Crop</h3><canvas id="landChart" height="160"></canvas></div>
    <div class="glass p-4 col-span-full"><h3 class="font-semibold mb-2">7) Time Trend</h3><canvas id="timeChart" height="220"></canvas></div>
  </section>

  <!-- DATA TABLE -->
  <section class="px-5 mt-6 mb-16">
    <div class="glass p-4">
      <h3 class="font-semibold mb-2">Records</h3>
      <div class="table-wrapper">
        <table id="dataTable"><thead></thead><tbody></tbody></table>
      </div>
    </div>
  </section>

  <div id="toast" class="toast"></div>

<script>
// ====== CONFIG ======
const CSV_URL_DEFAULT = 'https://raw.githubusercontent.com/USERNAME/REPO/main/data.csv'; // 🔁 Replace with your public RAW CSV URL
const REQUIRE_LOGIN = true; // keep login mandatory
const AUTO_REFRESH_MS = 0;  // set (e.g., 300000 for 5m) if you want auto-refresh

// ====== AUTH ======
(function auth(){
  const ok = sessionStorage.getItem('digicides_auth_ok');
  if(REQUIRE_LOGIN && ok!=='1'){
    document.getElementById('loginOverlay').style.display='flex';
    document.getElementById('loginForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const u=document.getElementById('username').value.trim();
      const p=document.getElementById('password').value.trim();
      if(u==='digicides' && p==='coromandel@cpc'){
        sessionStorage.setItem('digicides_auth_ok','1');
        document.getElementById('loginOverlay').style.display='none';
        initApp();
      } else {
        document.getElementById('loginErr').classList.remove('hidden');
      }
    });
  } else {
    document.getElementById('loginOverlay').style.display='none';
    initApp();
  }
})();

// ====== STATE ======
let rawRows=[]; let rows=[]; let charts={}; let productsMaster=new Set();
const columnsOrder=['User ID','Phone Number','First Name','Last Name','District','State','Language','Pin Code','QR Code','Land Acreage','Crop Name','Scan Date','RIN','Retailer Name','Cart Items','Coupon Code','Submission Status'];

// ====== UTILS ======
function toast(msg, isErr=false){
  const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; t.style.borderColor=isErr?'#ff7272':'rgba(255,255,255,0.12)';
  setTimeout(()=>{t.style.display='none'}, 3800);
}
function toNumber(x){ if(x==null||x==='') return null; const n=Number(String(x).replace(/,/g,'').trim()); return Number.isFinite(n)?n:null; }
function norm(x){ return (x==null?'':String(x)).trim(); }
function parseDateSmart(s){ if(!s) return null; const str=String(s).trim(); let d=dayjs(str); if(!d.isValid()){ const m=str.match(/(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/); if(m){ const [_,dd,MM,yyyy,hh,mm,ss]=m; const iso=`${yyyy}-${MM}-${dd}${hh?` ${hh}:${mm||'00'}:${ss||'00'}`:''}`; d=dayjs(iso);} } return d.isValid()?d:null; }
function parseCartItems(cart){ const out=[]; if(!cart) return out; String(cart).split(/\s*,\s*/).forEach(p=>{ const m=p.match(/^(.+?)\s*-\s*qty\s*(\d+)\s*-\s*([\w.]+)$/i); if(m){ out.push({name:m[1].trim(), qty:Number(m[2]), size:m[3].trim()}); } else if(p){ out.push({name:p.trim(), qty:1, size:''}); } }); return out; }
function uniqueSorted(arr){ return Array.from(new Set(arr)).filter(Boolean).sort((a,b)=> String(a).localeCompare(String(b))); }

// ====== FILTERS ======
function buildFilters(){
  const stateSel=document.getElementById('stateFilter');
  const districtSel=document.getElementById('districtFilter');
  const retailerSel=document.getElementById('retailerFilter');
  const cropSel=document.getElementById('cropFilter');
  const productSel=document.getElementById('productFilter');

  const states=uniqueSorted(rows.map(r=>r.State));
  const dists=uniqueSorted(rows.map(r=>r.District));
  const rets=uniqueSorted(rows.map(r=>r['Retailer Name']));
  const crops=uniqueSorted(rows.flatMap(r=> String(r['Crop Name']||'').split(/\s*,\s*/)));
  const prods=uniqueSorted(Array.from(productsMaster));
  function fill(sel, arr){ sel.innerHTML = `<option value="">All</option>` + arr.map(v=>`<option>${v}</option>`).join(''); }
  fill(stateSel, states); fill(districtSel, dists); fill(retailerSel, rets); fill(cropSel, crops); fill(productSel, prods);
}

function filteredRows(){
  const fs={ state:norm(document.getElementById('stateFilter').value), district:norm(document.getElementById('districtFilter').value), retailer:norm(document.getElementById('retailerFilter').value), crop:norm(document.getElementById('cropFilter').value), status:norm(document.getElementById('statusFilter').value), product:norm(document.getElementById('productFilter').value), qtyMin:toNumber(document.getElementById('qtyMin').value), qtyMax:toNumber(document.getElementById('qtyMax').value), search:norm(document.getElementById('searchBox').value).toLowerCase() };
  return rows.filter(r=>{
    if(fs.state && r.State!==fs.state) return false;
    if(fs.district && r.District!==fs.district) return false;
    if(fs.retailer && r['Retailer Name']!==fs.retailer) return false;
    if(fs.status && norm(r['Submission Status'])!==fs.status) return false;
    if(fs.crop){ const list=String(r['Crop Name']||'').split(/\s*,\s*/); if(!list.includes(fs.crop)) return false; }
    if(fs.product){ const ok=(r._cartParsed||[]).some(ci=>ci.name===fs.product); if(!ok) return false; }
    if(fs.qtyMin!=null || fs.qtyMax!=null){ let q=0; if(fs.product){ q=(r._cartParsed||[]).filter(ci=>ci.name===fs.product).reduce((a,b)=>a+(b.qty||0),0);} else { q=(r._cartParsed||[]).reduce((a,b)=>a+(b.qty||0),0);} if(fs.qtyMin!=null && q<fs.qtyMin) return false; if(fs.qtyMax!=null && q>fs.qtyMax) return false; }
    if(fs.search){ const hay=columnsOrder.map(c=>String(r[c]||'')).join('|').toLowerCase(); if(!hay.includes(fs.search)) return false; }
    return true;
  });
}

// ====== KPIs & CHARTS ======
function updateKPIs(list){ const total=list.length; const yes=list.filter(r=>norm(r['Submission Status'])==='Yes').length; const pen=list.filter(r=>norm(r['Submission Status'])==='Pending').length; const rate=total?Math.round(yes/total*100):0; kpiTotal.textContent=total; kpiYes.textContent=yes; kpiPending.textContent=pen; kpiRate.textContent=rate+'%'; }
function destroyChart(id){ if(charts[id]){ charts[id].destroy(); delete charts[id]; } }
function makeChart(id, type, labels, data, label){ destroyChart(id); const el=document.getElementById(id); charts[id]=new Chart(el,{ type, data:{ labels, datasets:[{ label, data }]}, options:{ responsive:true, maintainAspectRatio:false, plugins:{ legend:{ labels:{ color:'#e9eefb' } } }, scales:{ x:{ ticks:{ color:'#c8d0e0' } }, y:{ ticks:{ color:'#c8d0e0' } } } } }); }

function updateCharts(list){ try{
  // 1 status
  const s={}; list.forEach(r=>{ const k=norm(r['Submission Status'])||' '; s[k]=(s[k]||0)+1; });
  makeChart('statusChart','doughnut',Object.keys(s),Object.values(s),'Status');
  // 2 retailer
  const ret={}; list.forEach(r=>{ const k=norm(r['Retailer Name'])||'(blank)'; ret[k]=(ret[k]||0)+1; });
  const retTop=Object.entries(ret).sort((a,b)=>b[1]-a[1]).slice(0,10);
  makeChart('retailerChart','bar',retTop.map(x=>x[0]),retTop.map(x=>x[1]),'Scans');
  // 3 crop
  const crop={}; list.forEach(r=>String(r['Crop Name']||'').split(/\s*,\s*/).forEach(c=>{ if(c){ crop[c]=(crop[c]||0)+1; } }));
  const cropTop=Object.entries(crop).sort((a,b)=>b[1]-a[1]).slice(0,10);
  makeChart('cropChart','bar',cropTop.map(x=>x[0]),cropTop.map(x=>x[1]),'Scans');
  // 4 products (sum qty)
  const prod={}; list.forEach(r=> (r._cartParsed||[]).forEach(ci=>{ prod[ci.name]=(prod[ci.name]||0)+ (ci.qty||0); }));
  const prodTop=Object.entries(prod).sort((a,b)=>b[1]-a[1]).slice(0,10);
  makeChart('productChart','bar',prodTop.map(x=>x[0]),prodTop.map(x=>x[1]),'Qty');
  // 5 region by district
  const dist={}; list.forEach(r=>{ const k=norm(r.District)||'(blank)'; dist[k]=(dist[k]||0)+1; });
  const distTop=Object.entries(dist).sort((a,b)=>b[1]-a[1]).slice(0,10);
  makeChart('regionChart','bar',distTop.map(x=>x[0]),distTop.map(x=>x[1]),'Scans');
  // 6 avg land by crop
  const landSum={}, landCnt={}; list.forEach(r=>{ const c=norm(r['Crop Name'])||'(blank)'; const a=toNumber(r['Land Acreage'])||0; landSum[c]=(landSum[c]||0)+a; landCnt[c]=(landCnt[c]||0)+1; });
  const avg=Object.keys(landSum).map(k=> [k, landSum[k]/landCnt[k]]).sort((a,b)=>b[1]-a[1]).slice(0,10);
  makeChart('landChart','bar',avg.map(x=>x[0]),avg.map(x=>Number(x[1].toFixed(2))),'Avg Acres');
  // 7 time trend by hour
  const t={}; list.forEach(r=>{ const d=parseDateSmart(r['Scan Date']); if(d){ const k=d.format('YYYY-MM-DD HH:00'); t[k]=(t[k]||0)+1; } });
  const ts=Object.entries(t).sort((a,b)=> a[0].localeCompare(b[0]));
  makeChart('timeChart','line',ts.map(x=>x[0]),ts.map(x=>x[1]),'Scans');
 } catch(err){ console.error(err); toast('Chart render error. See console.', true); }
}

// ====== TABLE & EXPORT ======
function renderTable(list){ const thead=document.querySelector('#dataTable thead'); const tbody=document.querySelector('#dataTable tbody'); thead.innerHTML='<tr>'+columnsOrder.map(c=>`<th>${c}</th>`).join('')+'<th>Parsed Products</th></tr>'; tbody.innerHTML=list.map(r=>{ const tds=columnsOrder.map(c=>`<td>${r[c]??''}</td>`).join(''); const parsed=(r._cartParsed||[]).map(ci=>`${ci.name} (qty ${ci.qty}${ci.size?', '+ci.size:''})`).join(', '); return `<tr>${tds}<td>${parsed}</td></tr>`; }).join(''); }
function exportCSV(list){ const out=list.map(r=>{ const o=Object.fromEntries(columnsOrder.map(c=>[c, r[c]??''])); o['Parsed Product Names']=(r._cartParsed||[]).map(ci=>ci.name).join('|'); o['Parsed Total Qty']=(r._cartParsed||[]).reduce((a,b)=>a+(b.qty||0),0); return o; }); const csv=Papa.unparse(out); const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='filtered_export.csv'; a.click(); URL.revokeObjectURL(url); }

// ====== WIRING ======
function rebuild(){ const list=filteredRows(); updateKPIs(list); updateCharts(list); renderTable(list); }

['applyFilters','clearFilters','exportBtn','refreshBtn'].forEach(id=>{ document.addEventListener('click',(e)=>{ if(e.target.id===id){ if(id==='applyFilters') rebuild(); if(id==='clearFilters'){ ['stateFilter','districtFilter','retailerFilter','cropFilter','statusFilter','productFilter','qtyMin','qtyMax','searchBox'].forEach(x=>{ const el=document.getElementById(x); if(!el) return; if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }); rebuild(); } if(id==='exportBtn'){ exportCSV(filteredRows()); } if(id==='refreshBtn'){ fetchData(true); } } }); });

['stateFilter','districtFilter','retailerFilter','cropFilter','statusFilter','productFilter','qtyMin','qtyMax'].forEach(id=>{ document.addEventListener('change', (e)=>{ if(e.target && e.target.id===id) rebuild(); }); });

document.getElementById('searchBox').addEventListener('input', ()=>{ clearTimeout(window.__sb); window.__sb=setTimeout(rebuild, 180); });

document.getElementById('csvInput').addEventListener('change', (e)=>{ const file=e.target.files?.[0]; if(!file) return; Papa.parse(file,{header:true,skipEmptyLines:true,complete:(res)=>{ normalizeAndParse(res.data); toast('Loaded from file'); }, error:(err)=> toast('CSV parse error: '+err, true)}); });

// ====== DATA LOAD ======
function normalizeAndParse(data){ productsMaster=new Set(); rows=data.map(r=>{ const o={}; columnsOrder.forEach(c=> o[c]= r[c]!==undefined? r[c]:'' ); o['Land Acreage']=toNumber(o['Land Acreage']); o._scanDate=parseDateSmart(o['Scan Date']); o._cartParsed=parseCartItems(o['Cart Items']); (o._cartParsed||[]).forEach(ci=> productsMaster.add(ci.name)); return o; }); buildFilters(); rebuild(); }

function csvUrlFromQuery(){ const u=new URL(location.href); const q=u.searchParams.get('csv'); return q?decodeURIComponent(q):CSV_URL_DEFAULT; }

async function fetchData(isManual=false){ try{ const url=csvUrlFromQuery(); const res=await fetch(url, { cache:'no-store' }); if(!res.ok) throw new Error('HTTP '+res.status+' for '+url); const text=await res.text(); const parsed=Papa.parse(text, { header:true, skipEmptyLines:true }); if(parsed.errors && parsed.errors.length){ console.warn('CSV parse errors', parsed.errors.slice(0,3)); }
  rawRows=parsed.data; if(!rawRows || !rawRows.length){ throw new Error('No rows in CSV'); }
  normalizeAndParse(rawRows); toast((isManual?'Refreshed':'Loaded')+' from CSV');
 } catch(err){ console.error(err); toast('Failed to load CSV. You can use Upload CSV (fallback).', true); }
}

function initApp(){ fetchData(false); if(AUTO_REFRESH_MS>0){ setInterval(()=>fetchData(), AUTO_REFRESH_MS); } }
</script>
</body>
</html>
