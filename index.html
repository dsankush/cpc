<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
  <link rel="manifest" href="site.webmanifest">
  <link rel="shortcut icon" href="favicon.ico" />
  <title>Coromandel CPC — Campaign Dashboard</title>
  <!-- Lightweight fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Chart.js & PapaParse (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      --bg:#0f172a;          /* slate-900 */
      --panel:#0b1223;       /* deeper */
      --card:#111c32;        /* card */
      --muted:#94a3b8;       /* slate-400 */
      --text:#e2e8f0;        /* slate-200 */
      --acc1:#22d3ee;        /* cyan-400 */
      --acc2:#fb923c;        /* orange-400 */
      --acc3:#10b981;        /* emerald-500 */
      --ring:#1e293b;        /* slate-800 */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#0a0f1e) fixed;color:var(--text)}
    .app{display:grid;grid-template-rows:auto 1fr;min-height:100vh}
    header{position:sticky;top:0;z-index:30;backdrop-filter:saturate(140%) blur(10px);background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(15,23,42,.6));border-bottom:1px solid var(--ring)}
    .bar{display:flex;align-items:center;gap:16px;padding:14px 18px}
    .logo{display:flex;align-items:center;gap:10px;font-weight:700}
    .dot{width:10px;height:10px;border-radius:999px;background:linear-gradient(135deg,var(--acc1),var(--acc2))}
    .title{letter-spacing:.3px}
    .pill{margin-left:auto;display:flex;gap:8px}
    .pill > div{background:var(--card);border:1px solid var(--ring);padding:6px 10px;border-radius:999px;font-size:12px;color:var(--muted)}

    /* Layout */
    .main{display:grid;grid-template-columns:280px 1fr;gap:18px;padding:18px}
    .side{display:flex;flex-direction:column;gap:12px}
    .panel{background:var(--panel);border:1px solid var(--ring);border-radius:16px;padding:14px}

    .filters .group{display:flex;flex-direction:column;gap:6px}
    .filters label{font-size:12px;color:var(--muted)}
    .filters select,.filters input{width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--ring);background:#0d1933;color:var(--text);outline:none}

    .content{display:grid;grid-template-columns:repeat(12,1fr);gap:18px}
    .card{background:var(--card);border:1px solid var(--ring);border-radius:18px;padding:14px;min-height:140px;display:flex;flex-direction:column}
    .card h3{margin:0 0 8px;font-size:14px;color:#cbd5e1;font-weight:600}
    .kpi{font-size:34px;font-weight:700;line-height:1.1}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;color:var(--muted);font-size:12px}

    .footer{padding:10px 18px;color:var(--muted);border-top:1px solid var(--ring)}

    /* Login overlay */
    .overlay{position:fixed;inset:0;background:radial-gradient(1200px 800px at 10% 10%,rgba(34,211,238,.15),transparent 60%),radial-gradient(1000px 700px at 100% 0,rgba(16,185,129,.1),transparent 60%),#051024;display:grid;place-items:center;z-index:50}
    .login{width:min(92vw,380px);background:var(--panel);border:1px solid var(--ring);border-radius:20px;padding:22px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
    .login h2{margin:0 0 4px;font-size:20px}
    .login p{margin:0 0 14px;color:var(--muted);font-size:13px}
    .field{display:flex;flex-direction:column;gap:6px;margin:10px 0}
    .field label{font-size:12px;color:var(--muted)}
    .field input{padding:12px;border-radius:12px;border:1px solid var(--ring);background:#0d1933;color:var(--text)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:11px 14px;border-radius:12px;border:1px solid #174162;background:linear-gradient(180deg,#14324f,#0c2744);color:#e6f4ff;font-weight:600;cursor:pointer}
    .btn:hover{filter:brightness(1.05)}
    .err{color:#fca5a5;font-size:12px;min-height:16px}

    /* Responsive */
    @media (max-width: 1000px){
      .main{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="bar">
      <div class="logo"><span class="dot"></span><span class="title">CPC Campaign Dashboard</span></div>
      <div class="pill">
        <div id="kpi-total">Scans: 0</div>
        <div id="kpi-yes">Approved: 0</div>
        <div id="kpi-pending">Pending: 0</div>
      </div>
    </div>
  </header>

  <main class="main">
    <!-- Sidebar Filters -->
    <aside class="side">
      <div class="panel filters">
        <div class="group">
          <label for="state">State</label>
          <select id="state"></select>
        </div>
        <div class="group">
          <label for="district">District</label>
          <select id="district"></select>
        </div>
        <div class="group">
          <label for="retailer">Retailer</label>
          <select id="retailer"></select>
        </div>
        <div class="group">
          <label for="product">Product</label>
          <select id="product"></select>
        </div>
        <div class="group">
          <label for="qtyMin">Quantity (≥)</label>
          <input id="qtyMin" type="number" min="0" step="1" placeholder="0" />
        </div>
        <div class="group">
          <label for="status">Approved Status</label>
          <select id="status"></select>
        </div>
        <div class="row" style="margin-top:6px">
          <button class="btn" id="resetBtn">Reset Filters</button>
        </div>
      </div>
      <div class="panel">
        <div class="row">CSV Source:</div>
        <div class="row" style="word-break:break-all"><code id="csvPath">./data.csv</code></div>
      </div>
    </aside>

    <!-- Content -->
    <section class="content">
      <div class="card" style="grid-column: span 3">
        <h3>Total Scans</h3>
        <div class="kpi" id="kpiTotalBig">0</div>
        <div class="row" id="kpiMeta"></div>
      </div>
      <div class="card" style="grid-column: span 3">
        <h3>Submission Status (Approved)</h3>
        <canvas id="statusChart" height="140"></canvas>
      </div>
      <div class="card" style="grid-column: span 6">
        <h3>Time Trend (Scans per Day)</h3>
        <canvas id="trendChart" height="140"></canvas>
      </div>

      <div class="card" style="grid-column: span 6">
        <h3>Retailer Performance (Scans)</h3>
        <canvas id="retailerChart" height="160"></canvas>
      </div>
      <div class="card" style="grid-column: span 6">
        <h3>District-wise Scans</h3>
        <canvas id="districtChart" height="160"></canvas>
      </div>

      <div class="card" style="grid-column: span 12">
        <h3>Product Basket (Parsed from Cart Items)</h3>
        <canvas id="productChart" height="140"></canvas>
      </div>
    </section>
  </main>
  <div class="footer">© 2025 Coromandel CPC — Lightweight dashboard (no frameworks). Built for GitHub Pages.</div>
</div>

<!-- Login Overlay -->
<div class="overlay" id="loginOverlay" aria-hidden="false">
  <form class="login" id="loginForm">
    <h2>Secure Access</h2>
    <p>Please login to view the dashboard.</p>
    <div class="field">
      <label>Username</label>
      <input id="u" autocomplete="username" placeholder="Username" />
    </div>
    <div class="field">
      <label>Password</label>
      <input id="p" type="password" autocomplete="current-password" placeholder="Password" />
    </div>
    <div class="row" style="justify-content:space-between">
      <button class="btn" type="submit">Login</button>
      <span class="err" id="err"></span>
    </div>
  </form>
</div>

<script>
  // =====================
  //  CONFIG
  // =====================
  const CSV_URL = './data.csv'; // Put your data.csv at repo root (or adjust path)
  document.getElementById('csvPath').textContent = CSV_URL;

  // =====================
  //  SIMPLE LOGIN (client-side; suitable for lightweight gating only)
  // =====================
  const VALID_USER = 'digicides';
  const VALID_PASS = 'coro@cpc';
  const overlay = document.getElementById('loginOverlay');
  const form = document.getElementById('loginForm');
  const errEl = document.getElementById('err');
  const LS_KEY = 'cpc_login_ok';

  function unlock(){ overlay.style.display='none'; }
  if(localStorage.getItem(LS_KEY)==='1'){ unlock(); }
  form.addEventListener('submit', (e)=>{
    e.preventDefault();
    const u = document.getElementById('u').value.trim();
    const p = document.getElementById('p').value;
    if(u===VALID_USER && p===VALID_PASS){
      localStorage.setItem(LS_KEY,'1');
      unlock();
    } else {
      errEl.textContent = 'Invalid credentials';
    }
  });

  // =====================
  //  UTILITIES
  // =====================
  const by = (k)=> (a,b)=> a[k]>b[k]?1:(a[k]<b[k]?-1:0);
  const trim = (s)=> (s==null?'' : String(s).trim());
  const toDateKey = (dt)=>{
    if(!dt) return '';
    const d = new Date(dt.replace(/-/g,'/')); // tolerate 'YYYY-MM-DD HH:mm:ss'
    if(isNaN(d)) return '';
    return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0');
  };

  function uniqSorted(arr){ return [...new Set(arr.filter(Boolean))].sort((a,b)=>a.localeCompare(b)); }

  // Parse "Cart Items" like: "Fantac Plus - qty 2 - 1000ml, Benofit - qty 1 - 400gms"
  function parseProducts(cartStr){
    const map = new Map();
    const s = trim(cartStr);
    if(!s) return map;
    const parts = s.split(',');
    for(const raw of parts){
      const item = raw.trim();
      // capture: name, qty (optional)
      const m = item.match(/^(.+?)\s*-\s*qty\s*(\d+)/i) || item.match(/^(.+?)\s*$/);
      if(m){
        const name = trim(m[1]).replace(/\s{2,}/g,' ');
        const q = m[2] ? Number(m[2]) : 1;
        map.set(name, (map.get(name)||0)+ (isFinite(q)? q : 1));
      }
    }
    return map;
  }

  // =====================
  //  STATE
  // =====================
  let RAW = [];
  let FILTERS = { state:'', district:'', retailer:'', product:'', qtyMin:0, status:'' };

  // =====================
  //  DOM REFS
  // =====================
  const selState = document.getElementById('state');
  const selDistrict = document.getElementById('district');
  const selRetailer = document.getElementById('retailer');
  const selProduct = document.getElementById('product');
  const inpQtyMin = document.getElementById('qtyMin');
  const selStatus = document.getElementById('status');
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    FILTERS = { state:'', district:'', retailer:'', product:'', qtyMin:0, status:'' };
    selState.value = selDistrict.value = selRetailer.value = selProduct.value = selStatus.value = '';
    inpQtyMin.value = '';
    render();
  });

  // =====================
  //  CHARTS (reuse instances)
  // =====================
  const charts = {};
  function makeChart(id, type, data, opts){
    const ctx = document.getElementById(id).getContext('2d');
    if(charts[id]){ charts[id].data = data; charts[id].options = opts; charts[id].update(); return charts[id]; }
    charts[id] = new Chart(ctx, { type, data, options: opts });
    return charts[id];
  }

  function palette(n){
    const base = [ '#22d3ee','#fb923c','#10b981','#a78bfa','#f472b6','#fbbf24','#60a5fa','#34d399','#f87171' ];
    const arr = []; for(let i=0;i<n;i++) arr.push(base[i%base.length]);
    return arr;
  }

  // =====================
  //  RENDER PIPELINE
  // =====================
  function applyFilters(rows){
    const f = FILTERS;
    return rows.filter(r=>{
      if(f.state && trim(r.State)!==f.state) return false;
      if(f.district && trim(r.District)!==f.district) return false;
      if(f.retailer && trim(r['Retailer Name'])!==f.retailer) return false;
      if(f.status && trim((r['Submission Status']||'').toLowerCase())!==f.status.toLowerCase()) return false;
      if(f.product || (f.qtyMin||0)>0){
        const map = parseProducts(r['Cart Items']);
        if(f.product){
          const has = map.has(f.product);
          if(!has) return false;
          if((f.qtyMin||0)>0 && (map.get(f.product)||0) < f.qtyMin) return false;
        } else if((f.qtyMin||0)>0){
          // any product >= qtyMin qualifies
          let ok=false; for(const v of map.values()){ if(v>=f.qtyMin){ ok=true; break; } }
          if(!ok) return false;
        }
      }
      return true;
    });
  }

  function updateKpis(rows){
    const total = rows.length;
    const yes = rows.filter(r=>/^yes$/i.test(trim(r['Submission Status']))).length;
    const pending = rows.filter(r=>/^pending$/i.test(trim(r['Submission Status']))).length;
    const no = rows.filter(r=>/^no$/i.test(trim(r['Submission Status']))).length;
    document.getElementById('kpi-total').textContent = `Scans: ${total}`;
    document.getElementById('kpi-yes').textContent = `Approved: ${yes}`;
    document.getElementById('kpi-pending').textContent = `Pending: ${pending}`;
    document.getElementById('kpiTotalBig').textContent = total.toLocaleString();
    document.getElementById('kpiMeta').textContent = `${yes} Yes • ${no} No • ${pending} Pending`;
  }

  function buildCounts(rows, key){
    const m = new Map();
    for(const r of rows){
      const k = trim(r[key]); if(!k) continue;
      m.set(k, (m.get(k)||0)+1);
    }
    return [...m.entries()].sort((a,b)=>b[1]-a[1]);
  }

  function renderCharts(rows){
    // Status donut
    const sYes = rows.filter(r=>/^yes$/i.test(trim(r['Submission Status']))).length;
    const sNo = rows.filter(r=>/^no$/i.test(trim(r['Submission Status']))).length;
    const sPending = rows.filter(r=>/^pending$/i.test(trim(r['Submission Status']))).length;
    makeChart('statusChart','doughnut',{
      labels:['Yes','No','Pending'],
      datasets:[{ data:[sYes,sNo,sPending], backgroundColor:palette(3) }]
    },{
      plugins:{ legend:{ labels:{ color: '#cbd5e1' } } },
      cutout:'62%'
    });

    // Trend by day
    const trendMap = new Map();
    for(const r of rows){ const k = toDateKey(trim(r['Scan Date'])); if(k) trendMap.set(k,(trendMap.get(k)||0)+1); }
    const trend = [...trendMap.entries()].sort((a,b)=>a[0].localeCompare(b[0]));
    makeChart('trendChart','line',{
      labels: trend.map(x=>x[0]),
      datasets:[{ data: trend.map(x=>x[1]), borderWidth:2, tension:.3 }]
    },{ scales:{ x:{ ticks:{ color:'#8aa1c6' } }, y:{ ticks:{ color:'#8aa1c6' }, grid:{ color:'#1e2a44' } } }, plugins:{ legend:{ display:false } } });

    // Retailer performance
    const retailers = buildCounts(rows,'Retailer Name').slice(0,12);
    makeChart('retailerChart','bar',{
      labels: retailers.map(x=>x[0]),
      datasets:[{ data: retailers.map(x=>x[1]), backgroundColor: palette(retailers.length) }]
    },{ indexAxis:'y', plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#8aa1c6' } }, y:{ ticks:{ color:'#cbd5e1' } } } });

    // District scans
    const districts = buildCounts(rows,'District').slice(0,12);
    makeChart('districtChart','bar',{
      labels: districts.map(x=>x[0]),
      datasets:[{ data: districts.map(x=>x[1]), backgroundColor: palette(districts.length) }]
    },{ indexAxis:'y', plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#8aa1c6' } }, y:{ ticks:{ color:'#cbd5e1' } } } });

    // Product basket
    const pMap = new Map();
    for(const r of rows){
      const m = parseProducts(r['Cart Items']);
      for(const [name,qty] of m){ pMap.set(name,(pMap.get(name)||0)+qty); }
    }
    const pArr = [...pMap.entries()].sort((a,b)=>b[1]-a[1]).slice(0,16);
    makeChart('productChart','bar',{
      labels: pArr.map(x=>x[0]),
      datasets:[{ data: pArr.map(x=>x[1]), backgroundColor: palette(pArr.length) }]
    },{ plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#cbd5e1', maxRotation:30, minRotation:0 } }, y:{ ticks:{ color:'#8aa1c6' } } } });
  }

  function populateFilters(rows){
    const states = uniqSorted(rows.map(r=>trim(r.State)));
    const dists  = uniqSorted(rows.map(r=>trim(r.District)));
    const rets   = uniqSorted(rows.map(r=>trim(r['Retailer Name'])));
    const products = uniqSorted(rows.flatMap(r=>[...parseProducts(r['Cart Items']).keys()]));
    const statuses = ['','Yes','No','Pending'];

    function fill(sel, items){ sel.innerHTML = ''; const opt0 = document.createElement('option'); opt0.value=''; opt0.textContent='All'; sel.appendChild(opt0); for(const v of items){ const o=document.createElement('option'); o.value=v; o.textContent=v; sel.appendChild(o);} }
    fill(selState, states); fill(selDistrict, dists); fill(selRetailer, rets); fill(selProduct, products);
    fill(selStatus, statuses);
  }

  function attachFilterHandlers(){
    selState.onchange = ()=>{ FILTERS.state = selState.value; render(); };
    selDistrict.onchange = ()=>{ FILTERS.district = selDistrict.value; render(); };
    selRetailer.onchange = ()=>{ FILTERS.retailer = selRetailer.value; render(); };
    selProduct.onchange = ()=>{ FILTERS.product = selProduct.value; render(); };
    selStatus.onchange = ()=>{ FILTERS.status = selStatus.value; render(); };
    let to=null; inpQtyMin.oninput = ()=>{ clearTimeout(to); to=setTimeout(()=>{ FILTERS.qtyMin = Number(inpQtyMin.value||0); render(); }, 180); };
  }

  function render(){
    const rows = applyFilters(RAW);
    updateKpis(rows);
    // Defer charts to next frame for smoother feel
    requestAnimationFrame(()=> renderCharts(rows));
  }

  // =====================
  //  LOAD CSV
  // =====================
  function normalizeRow(r){
    // ensure all expected columns exist
    const obj = {
      'User ID': r['User ID']||r['UserID']||r['id']||'',
      'Phone Number': r['Phone Number']||r['Phone']||r['phone']||'',
      'First Name': r['First Name']||r['FirstName']||'',
      'Last Name': r['Last Name']||r['LastName']||'',
      'District': r['District']||'',
      'State': r['State']||'',
      'Language': r['Language']||'',
      'Pin Code': r['Pin Code']||r['Pincode']||'',
      'QR Code': r['QR Code']||'',
      'Land Acreage': r['Land Acreage']||r['Land']||'',
      'Crop Name': r['Crop Name']||'',
      'Scan Date': r['Scan Date']||r['Date']||'',
      'RIN': r['RIN']||'',
      'Retailer Name': r['Retailer Name']||r['Retailer']||'',
      'Cart Items': r['Cart Items']||'',
      'Coupon Code': r['Coupon Code']||'',
      'Submission Status': r['Submission Status']||r['Approved Status']||''
    };
    return obj;
  }

  Papa.parse(CSV_URL, {
    download: true,
    header: true,
    skipEmptyLines: true,
    complete: (res)=>{
      RAW = res.data.map(normalizeRow);
      populateFilters(RAW);
      attachFilterHandlers();
      render();
    },
    error: (err)=>{
      console.error('CSV load error', err);
      alert('Failed to load data.csv. Ensure the file exists at '+CSV_URL);
    }
  });
</script>
</body>
</html>
