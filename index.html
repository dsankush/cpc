<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digicides • Campaign Analytics</title>
  <!-- TailwindCSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <!-- PapaParse for CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- Day.js for dates -->
  <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.11/dayjs.min.js"></script>
  <!-- XLSX for Excel downloads -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg: #08101f; --panel: #101528; --accent: #9bff57; --accent2: #6ce1ff; --text: #e8eef9; --muted: #98a2b3; --chip: #1a2140; --chip-active: #2a345d;
    }
    html, body { background: var(--bg); color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .glass { background: rgba(255,255,255,0.04); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; }
    .btn { background: linear-gradient(90deg, var(--accent), var(--accent2)); color:#00131a; font-weight:700; transition: all .2s; }
    .btn:hover { filter: brightness(1.06); }
    .chip { background: var(--chip); padding: 6px 12px; border-radius: 999px; cursor: pointer; color: var(--muted); border: 1px solid rgba(255,255,255,0.08) }
    .chip.active { background: var(--chip-active); color: var(--text); }
    .grid-cards { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 14px; }
    .chart-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(340px,1fr)); gap:18px; }
    .card-chart { height: 260px; }
    .card-chart.tall { height: 320px; }
    .card-chart canvas { width:100% !important; height:100% !important; background: #0c1224; border-radius: 12px; padding: 8px; }
    .neon-title { font-weight: 800; letter-spacing: .5px; background: linear-gradient(90deg, var(--accent), var(--accent2)); -webkit-background-clip: text; background-clip: text; color: transparent; }
    .login-bg { position: fixed; inset:0; display:flex; align-items:center; justify-content:center; background:#05070f; z-index:50; }
    .table-wrapper { max-height: 360px; overflow:auto; }
    table { width:100%; border-collapse: collapse; font-size: 13px; }
    th, td { border-bottom: 1px solid rgba(255,255,255,0.06); padding: 8px 10px; }
    th { position: sticky; top:0; background: #0f1630; text-align:left; z-index: 1; }
    .toast { position: fixed; right: 16px; bottom: 16px; background: #0f1630; border: 1px solid rgba(255,255,255,0.12); padding: 10px 14px; border-radius: 12px; display:none }
    .sticky-aside { position: sticky; top: 16px; align-self: start; }
    .loading { position: fixed; inset:0; display:none; place-items:center; background: rgba(5,7,15,0.6); z-index:40 }
    .modal { position: fixed; inset:0; display:none; place-items:center; background: rgba(0,0,0,0.6); z-index:60 }
  </style>
</head>
<body>
  <!-- LOGIN OVERLAY (kept) -->
  <div id="loginOverlay" class="login-bg">
    <div class="glass p-8 w-full max-w-md">
      <h1 class="text-2xl neon-title mb-4">Digicides • Campaign Dashboard</h1>
      <form id="loginForm" class="space-y-4" autocomplete="off">
        <input id="username" class="w-full px-3 py-2 rounded bg-[#0a1022] border border-slate-700" placeholder="Username" />
        <input id="password" type="password" class="w-full px-3 py-2 rounded bg-[#0a1022] border border-slate-700" placeholder="Password" />
        <button class="btn w-full py-2 rounded" type="submit">Login</button>
        <p id="loginErr" class="hidden text-red-400 text-sm">Invalid credentials.</p>
        <p class="text-xs text-slate-400 mt-2">Hint: digicides / coromandel@cpc</p>
      </form>
    </div>
  </div>

  <div id="loading" class="loading"><div class="glass p-4">Loading data…</div></div>

  <header class="p-5 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <i class="fa-solid fa-seedling text-xl" style="color:var(--accent)"></i>
      <h1 class="text-xl neon-title">Coromandel Campaign Insights</h1>
    </div>
    <div class="flex items-center gap-2">
      <button id="downloadsBtn" class="chip"><i class="fa-solid fa-download mr-2"></i>Downloads</button>
      <button id="refreshBtn" class="chip"><i class="fa-solid fa-rotate mr-2"></i>Refresh</button>
      <label class="chip" for="csvInput"><i class="fa-solid fa-file-arrow-up mr-2"></i>Upload CSV (fallback)</label>
      <input id="csvInput" type="file" accept=".csv" class="hidden" />
    </div>
  </header>

  <main class="px-5 grid grid-cols-1 xl:grid-cols-[1fr_320px] gap-5">
    <!-- LEFT: KPIs + Charts + Table -->
    <section>
      <!-- KPI CARDS -->
      <div class="grid-cards">
        <div class="glass p-4"><p class="text-xs">Total Scans</p><p id="kpiTotal" class="text-2xl font-bold">0</p></div>
        <div class="glass p-4"><p class="text-xs">Completed (Yes)</p><p id="kpiYes" class="text-2xl font-bold">0</p></div>
        <div class="glass p-4"><p class="text-xs">Pending</p><p id="kpiPending" class="text-2xl font-bold">0</p></div>
        <div class="glass p-4"><p class="text-xs">Completion Rate</p><p id="kpiRate" class="text-2xl font-bold">0%</p></div>
      </div>

      <!-- CHARTS: 7 Analytics -->
      <section class="mt-6 chart-grid">
        <div class="glass p-4"><h3 class="font-semibold mb-2">1) Submission Status</h3><div class="card-chart"><canvas id="statusChart"></canvas></div></div>
        <div class="glass p-4"><h3 class="font-semibold mb-2">2) Retailer Performance (Yes vs Pending)</h3><div class="card-chart"><canvas id="retailerChart"></canvas></div></div>
        <div class="glass p-4"><h3 class="font-semibold mb-2">3) Crop-wise Registrations</h3><div class="card-chart"><canvas id="cropChart"></canvas></div></div>
        <div class="glass p-4"><h3 class="font-semibold mb-2">4) Top Products (from Cart Items)</h3><div class="card-chart"><canvas id="productChart"></canvas></div></div>
        <div class="glass p-4"><h3 class="font-semibold mb-2">5) District & State Analysis</h3><div class="card-chart"><canvas id="regionChart"></canvas></div></div>
        <div class="glass p-4"><h3 class="font-semibold mb-2">6) Avg Land Size by Crop</h3><div class="card-chart"><canvas id="landChart"></canvas></div></div>
        <div class="glass p-4 xl:col-span-2"><h3 class="font-semibold mb-2">7) Time Trend (Scan Date)</h3><div class="card-chart tall"><canvas id="timeChart"></canvas></div></div>
      </section>

      <!-- DATA TABLE -->
      <section class="mt-6 mb-16">
        <div class="glass p-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="font-semibold">Records</h3>
            <div class="flex gap-2 items-center">
              <input id="searchBox" placeholder="Search…" class="px-3 py-2 rounded bg-[#0a1022] border border-slate-700"/>
              <button id="exportBtn" class="chip"><i class="fa-solid fa-file-csv mr-2"></i>Export Filtered CSV</button>
            </div>
          </div>
          <div class="table-wrapper">
            <table id="dataTable"><thead></thead><tbody></tbody></table>
          </div>
        </div>
      </section>
    </section>

    <!-- RIGHT: FILTER PANEL (All requested filters) -->
    <aside class="glass p-4 sticky-aside">
      <h3 class="font-semibold mb-3">Filter</h3>
      <div class="space-y-3">
        <div>
          <label class="text-xs text-slate-300">State</label>
          <select id="stateFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700"></select>
        </div>
        <div>
          <label class="text-xs text-slate-300">District</label>
          <select id="districtFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700"></select>
        </div>
        <div>
          <label class="text-xs text-slate-300">Retailer</label>
          <select id="retailerFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700"></select>
        </div>
        <div>
          <label class="text-xs text-slate-300">Crop</label>
          <select id="cropFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700"></select>
        </div>
        <div>
          <label class="text-xs text-slate-300">Language</label>
          <select id="languageFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700"></select>
        </div>
        <div>
          <label class="text-xs text-slate-300">Submission Status</label>
          <select id="statusFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700">
            <option value="">All</option>
            <option value="Yes">Yes</option>
            <option value="Pending">Pending</option>
          </select>
        </div>
        <div>
          <label class="text-xs text-slate-300">Product</label>
          <select id="productFilter" class="w-full mt-1 px-3 py-2 rounded bg-[#0a1022] border border-slate-700"></select>
        </div>
        <div>
          <label class="text-xs text-slate-300">Quantity (sum per row)</label>
          <div class="grid grid-cols-2 gap-2">
            <input id="qtyMin" type="number" class="px-3 py-2 rounded bg-[#0a1022] border border-slate-700" placeholder="Min" />
            <input id="qtyMax" type="number" class="px-3 py-2 rounded bg-[#0a1022] border border-slate-700" placeholder="Max" />
          </div>
        </div>
        <div class="flex gap-2 pt-1">
          <button id="applyFilters" class="btn px-4 py-2 rounded-xl"><i class="fa-solid fa-filter mr-2"></i>Apply</button>
          <button id="clearFilters" class="chip"><i class="fa-solid fa-broom mr-2"></i>Clear</button>
        </div>
      </div>
    </aside>
  </main>

  <!-- DOWNLOADS MODAL (Excel) -->
  <div id="downloadsModal" class="modal">
    <div class="glass p-6 w-full max-w-lg">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-lg font-semibold">Downloads</h3>
        <button id="closeDownloads" class="chip"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <p class="text-sm text-slate-300 mb-4">Download the complete or filtered dataset in Excel format.</p>
      <div class="grid sm:grid-cols-2 gap-3">
        <button id="dlFullXLSX" class="btn py-2 rounded">Full data (.xlsx)</button>
        <button id="dlFilteredXLSX" class="chip py-2">Filtered data (.xlsx)</button>
        <button id="dlKPIsXLSX" class="chip py-2">KPI summary (.xlsx)</button>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

<script>
// ====== CONFIG ======
// Your GitHub page URL will be auto-converted to a RAW URL for fetching.
const CSV_URL_DEFAULT = 'https://github.com/dsankush/cpc/blob/main/data.csv';
const REQUIRE_LOGIN = true; // keep login mandatory
const AUTO_REFRESH_MS = 0;  // set (e.g., 300000 for 5m) if you want auto-refresh

// ====== AUTH ======
(function auth(){
  const ok = sessionStorage.getItem('digicides_auth_ok');
  if(REQUIRE_LOGIN && ok!=='1'){
    document.getElementById('loginOverlay').style.display='flex';
    document.getElementById('loginForm').addEventListener('submit', (e)=>{
      e.preventDefault();
      const u=document.getElementById('username').value.trim();
      const p=document.getElementById('password').value.trim();
      if(u==='digicides' && p==='coromandel@cpc'){
        sessionStorage.setItem('digicides_auth_ok','1');
        document.getElementById('loginOverlay').style.display='none';
        initApp();
      } else {
        document.getElementById('loginErr').classList.remove('hidden');
      }
    });
  } else {
    document.getElementById('loginOverlay').style.display='none';
    initApp();
  }
})();

// ====== STATE ======
let rawRows=[]; let rows=[]; let charts={}; let productsMaster=new Set();
const columnsOrder=['User ID','Phone Number','First Name','Last Name','District','State','Language','Pin Code','QR Code','Land Acreage','Crop Name','Scan Date','RIN','Retailer Name','Cart Items','Coupon Code','Submission Status'];

// ====== UTILS ======
function toast(msg, isErr=false){ const t=document.getElementById('toast'); t.textContent=msg; t.style.display='block'; t.style.borderColor=isErr?'#ff7272':'rgba(255,255,255,0.12)'; setTimeout(()=>{t.style.display='none'}, 3800); }
function showLoading(on){ document.getElementById('loading').style.display = on? 'grid':'none'; }
function toNumber(x){ if(x==null||x==='') return null; const n=Number(String(x).replace(/,/g,'').trim()); return Number.isFinite(n)?n:null; }
function norm(x){ return (x==null?'':String(x)).trim(); }
function parseDateSmart(s){ if(!s) return null; const str=String(s).trim(); let d=dayjs(str); if(!d.isValid()){ const m=str.match(/(\d{1,2})[-\/](\d{1,2})[-\/](\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/); if(m){ const [_,dd,MM,yyyy,hh,mm,ss]=m; const iso=`${yyyy}-${MM}-${dd}${hh?` ${hh}:${mm||'00'}:${ss||'00'}`:''}`; d=dayjs(iso);} } return d.isValid()?d:null; }
function parseCartItems(cart){ const out=[]; if(!cart) return out; String(cart).split(/\s*,\s*/).forEach(p=>{ const m=p.match(/^(.+?)\s*-\s*qty\s*(\d+)\s*-\s*([\w.]+)$/i); if(m){ out.push({name:m[1].trim(), qty:Number(m[2]), size:m[3].trim()}); } else if(p){ out.push({name:p.trim(), qty:1, size:''}); } }); return out; }
function uniqueSorted(arr){ return Array.from(new Set(arr)).filter(Boolean).sort((a,b)=> String(a).localeCompare(String(b))); }
function normalizeGithubUrl(u){ try{ const url=new URL(u); if(url.hostname==='github.com'){ const parts=url.pathname.split('/').filter(Boolean); const i=parts.indexOf('blob'); if(i>-1){ return `https://raw.githubusercontent.com/${parts[0]}/${parts[1]}/${parts[i+1]}/${parts.slice(i+2).join('/')}`; } return u+(url.search? '&':'?')+'raw=1'; } return u; } catch{ return u; } }

// ====== FILTERS ======
function buildFilters(){
  const stateSel=document.getElementById('stateFilter');
  const districtSel=document.getElementById('districtFilter');
  const retailerSel=document.getElementById('retailerFilter');
  const cropSel=document.getElementById('cropFilter');
  const languageSel=document.getElementById('languageFilter');
  const productSel=document.getElementById('productFilter');

  const states=uniqueSorted(rows.map(r=>r.State));
  const dists=uniqueSorted(rows.map(r=>r.District));
  const rets=uniqueSorted(rows.map(r=>r['Retailer Name']));
  const crops=uniqueSorted(rows.flatMap(r=> String(r['Crop Name']||'').split(/\s*,\s*/)));
  const langs=uniqueSorted(rows.map(r=> r.Language));
  const prods=uniqueSorted(Array.from(productsMaster));
  function fill(sel, arr){ sel.innerHTML = `<option value="">All</option>` + arr.map(v=>`<option>${v}</option>`).join(''); }
  fill(stateSel, states); fill(districtSel, dists); fill(retailerSel, rets); fill(cropSel, crops); fill(languageSel, langs); fill(productSel, prods);
}

function filteredRows(){
  const fs={ state:norm(document.getElementById('stateFilter').value), district:norm(document.getElementById('districtFilter').value), retailer:norm(document.getElementById('retailerFilter').value), crop:norm(document.getElementById('cropFilter').value), language:norm(document.getElementById('languageFilter').value), status:norm(document.getElementById('statusFilter').value), product:norm(document.getElementById('productFilter').value), qtyMin:toNumber(document.getElementById('qtyMin').value), qtyMax:toNumber(document.getElementById('qtyMax').value), search:norm(document.getElementById('searchBox').value).toLowerCase() };
  return rows.filter(r=>{
    if(fs.state && r.State!==fs.state) return false;
    if(fs.district && r.District!==fs.district) return false;
    if(fs.retailer && r['Retailer Name']!==fs.retailer) return false;
    if(fs.language && r.Language!==fs.language) return false;
    if(fs.status && norm(r['Submission Status'])!==fs.status) return false;
    if(fs.crop){ const list=String(r['Crop Name']||'').split(/\s*,\s*/); if(!list.includes(fs.crop)) return false; }
    if(fs.product){ const ok=(r._cartParsed||[]).some(ci=>ci.name===fs.product); if(!ok) return false; }
    if(fs.qtyMin!=null || fs.qtyMax!=null){ let q=0; if(fs.product){ q=(r._cartParsed||[]).filter(ci=>ci.name===fs.product).reduce((a,b)=>a+(b.qty||0),0);} else { q=(r._cartParsed||[]).reduce((a,b)=>a+(b.qty||0),0);} if(fs.qtyMin!=null && q<fs.qtyMin) return false; if(fs.qtyMax!=null && q>fs.qtyMax) return false; }
    if(fs.search){ const hay=columnsOrder.map(c=>String(r[c]||'')).join('|').toLowerCase(); if(!hay.includes(fs.search)) return false; }
    return true;
  });
}

// ====== KPIs & CHARTS ======
Chart.defaults.color = '#d7e2f0';
Chart.defaults.font.family = 'Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif';
const CenterPct = { id:'CenterPct', beforeDraw(chart){ if(chart.config.type!=='doughnut') return; const ds=chart.data.datasets?.[0]; if(!ds) return; const total=ds.data.reduce((a,b)=>a+b,0)||0; if(!total) return; const yesIndex = chart.data.labels.findIndex(l=> l==='Yes'); const yes = yesIndex>-1? ds.data[yesIndex]:0; const pct = Math.round((yes/total)*100); const {ctx} = chart; const meta = chart.getDatasetMeta(0); if(!meta.data || !meta.data[0]) return; const c = meta.data[0].getProps(['x','y'], true); ctx.save(); ctx.fillStyle = '#e8eef9'; ctx.font = '700 28px Inter'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillText(pct+'%', c.x, c.y); ctx.restore(); }};

function updateKPIs(list){ const total=list.length; const yes=list.filter(r=>norm(r['Submission Status'])==='Yes').length; const pen=list.filter(r=>norm(r['Submission Status'])==='Pending').length; const rate=total?Math.round(yes/total*100):0; kpiTotal.textContent=total; kpiYes.textContent=yes; kpiPending.textContent=pen; kpiRate.textContent=rate+'%'; }
function destroyChart(id){ if(charts[id]){ charts[id].destroy(); delete charts[id]; } }

function makeDoughnut(id, labels, data){ destroyChart(id); charts[id]=new Chart(document.getElementById(id),{ type:'doughnut', plugins:[CenterPct], data:{ labels, datasets:[{ data }]}, options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{ labels:{ color:'#bcd' } } } } }); }
function makeBar(id, labels, data, horizontal=false){ destroyChart(id); charts[id]=new Chart(document.getElementById(id),{ type:'bar', data:{ labels, datasets:[{ label:'', data, borderWidth:1.5 }]}, options:{ indexAxis: horizontal? 'y':'x', responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{ display:false } }, scales:{ x:{ ticks:{ color:'#bcd', autoSkip:true }, stacked:false }, y:{ ticks:{ color:'#bcd' }, stacked:false } } } }); }
function makeStackedRetailer(id, labels, yesData, pendingData){ destroyChart(id); charts[id]=new Chart(document.getElementById(id),{ type:'bar', data:{ labels, datasets:[ { label:'Yes', data: yesData }, { label:'Pending', data: pendingData } ]}, options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{ labels:{ color:'#bcd' } } }, scales:{ x:{ stacked:true, ticks:{ color:'#bcd', autoSkip:true } }, y:{ stacked:true, ticks:{ color:'#bcd' } } } } }); }

function updateCharts(list){ try{
  // 1) Submission Status
  const s={}; list.forEach(r=>{ const k=norm(r['Submission Status'])||' '; s[k]=(s[k]||0)+1; });
  makeDoughnut('statusChart',Object.keys(s),Object.values(s));

  // 2) Retailer Performance (stacked Yes/Pending)
  const allRetailers = {} , yesR = {}, penR = {};
  list.forEach(r=>{ const k=norm(r['Retailer Name'])||'(blank)'; const st=norm(r['Submission Status']); allRetailers[k]=(allRetailers[k]||0)+1; if(st==='Yes') yesR[k]=(yesR[k]||0)+1; else if(st==='Pending') penR[k]=(penR[k]||0)+1; });
  const top = Object.entries(allRetailers).sort((a,b)=>b[1]-a[1]).slice(0,10).map(([k])=>k);
  makeStackedRetailer('retailerChart', top, top.map(k=>yesR[k]||0), top.map(k=>penR[k]||0));

  // 3) Crop-wise registrations (horizontal)
  const crop={}; list.forEach(r=>String(r['Crop Name']||'').split(/\s*,\s*/).forEach(c=>{ if(c){ crop[c]=(crop[c]||0)+1; } }));
  const cropTop=Object.entries(crop).sort((a,b)=>b[1]-a[1]).slice(0,10);
  makeBar('cropChart',cropTop.map(x=>x[0]),cropTop.map(x=>x[1]), true);

  // 4) Product frequency (sum qty, top 5)
  const prod={}; list.forEach(r=> (r._cartParsed||[]).forEach(ci=>{ prod[ci.name]=(prod[ci.name]||0)+ (ci.qty||0); }));
  const prodTop=Object.entries(prod).sort((a,b)=>b[1]-a[1]).slice(0,5);
  makeBar('productChart',prodTop.map(x=>x[0]),prodTop.map(x=>x[1]), true);

  // 5) Region (District) horizontal; State could be switched later via toggle
  const dist={}; list.forEach(r=>{ const k=norm(r.District)||'(blank)'; dist[k]=(dist[k]||0)+1; });
  const distTop=Object.entries(dist).sort((a,b)=>b[1]-a[1]).slice(0,10);
  makeBar('regionChart',distTop.map(x=>x[0]),distTop.map(x=>x[1]), true);

  // 6) Avg Land by Crop (horizontal)
  const landSum={}, landCnt={}; list.forEach(r=>{ const c=norm(r['Crop Name'])||'(blank)'; const a=toNumber(r['Land Acreage'])||0; landSum[c]=(landSum[c]||0)+a; landCnt[c]=(landCnt[c]||0)+1; });
  const avg=Object.keys(landSum).map(k=> [k, landSum[k]/landCnt[k]]).sort((a,b)=>b[1]-a[1]).slice(0,10);
  makeBar('landChart',avg.map(x=>x[0]),avg.map(x=>Number(x[1].toFixed(2))), true);

  // 7) Time trend (by hour)
  const t={}; list.forEach(r=>{ const d=parseDateSmart(r['Scan Date']); if(d){ const k=d.format('YYYY-MM-DD HH:00'); t[k]=(t[k]||0)+1; } });
  const ts=Object.entries(t).sort((a,b)=> a[0].localeCompare(b[0]));
  destroyChart('timeChart');
  charts['timeChart']=new Chart(document.getElementById('timeChart'),{ type:'line', data:{ labels: ts.map(x=>x[0]), datasets:[{ label:'Scans', data: ts.map(x=>x[1]), tension:0.35, fill:false, borderWidth:2 }] }, options:{ responsive:true, maintainAspectRatio:false, animation:false, plugins:{ legend:{ labels:{ color:'#bcd' } } }, scales:{ x:{ ticks:{ color:'#bcd', autoSkip:true, maxRotation:0 } }, y:{ ticks:{ color:'#bcd' } } } } });
 } catch(err){ console.error(err); toast('Chart render error. See console.', true); }
}

// ====== TABLE & EXPORTS ======
function renderTable(list){ const thead=document.querySelector('#dataTable thead'); const tbody=document.querySelector('#dataTable tbody'); thead.innerHTML='<tr>'+columnsOrder.map(c=>`<th>${c}</th>`).join('')+'<th>Parsed Products</th></tr>'; tbody.innerHTML=list.map(r=>{ const tds=columnsOrder.map(c=>`<td>${r[c]??''}</td>`).join(''); const parsed=(r._cartParsed||[]).map(ci=>`${ci.name} (qty ${ci.qty}${ci.size?', '+ci.size:''})`).join(', '); return `<tr>${tds}<td>${parsed}</td></tr>`; }).join(''); }
function exportCSV(list){ const out=list.map(r=>{ const o=Object.fromEntries(columnsOrder.map(c=>[c, r[c]??''])); o['Parsed Product Names']=(r._cartParsed||[]).map(ci=>ci.name).join('|'); o['Parsed Total Qty']=(r._cartParsed||[]).reduce((a,b)=>a+(b.qty||0),0); return o; }); const csv=Papa.unparse(out); const blob=new Blob([csv], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='filtered_export.csv'; a.click(); URL.revokeObjectURL(url); }
function exportXLSX(list, filename){ const out=list.map(r=>{ const o=Object.fromEntries(columnsOrder.map(c=>[c, r[c]??''])); o['Parsed Product Names']=(r._cartParsed||[]).map(ci=>ci.name).join('|'); o['Parsed Total Qty']=(r._cartParsed||[]).reduce((a,b)=>a+(b.qty||0),0); return o; }); const ws=XLSX.utils.json_to_sheet(out); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'Data'); XLSX.writeFile(wb, filename); }
function exportKPIsXLSX(){ const list=filteredRows(); const total=list.length; const yes=list.filter(r=>norm(r['Submission Status'])==='Yes').length; const pending=list.filter(r=>norm(r['Submission Status'])==='Pending').length; const rate=total?Math.round(yes/total*100):0; const rows=[{Metric:'Total Scans', Value:total}, {Metric:'Yes', Value:yes}, {Metric:'Pending', Value:pending}, {Metric:'Completion Rate %', Value:rate}]; const ws=XLSX.utils.json_to_sheet(rows); const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'KPIs'); XLSX.writeFile(wb, 'kpis_summary.xlsx'); }

// ====== WIRING ======
function rebuild(){ const list=filteredRows(); updateKPIs(list); updateCharts(list); renderTable(list); }

['applyFilters','clearFilters','exportBtn','refreshBtn','downloadsBtn','closeDownloads','dlFullXLSX','dlFilteredXLSX','dlKPIsXLSX'].forEach(id=>{
  document.addEventListener('click',(e)=>{
    if(e.target && e.target.id===id){
      if(id==='applyFilters') rebuild();
      if(id==='clearFilters'){ ['stateFilter','districtFilter','retailerFilter','cropFilter','languageFilter','statusFilter','productFilter','qtyMin','qtyMax','searchBox'].forEach(x=>{ const el=document.getElementById(x); if(!el) return; if(el.tagName==='SELECT') el.selectedIndex=0; else el.value=''; }); rebuild(); }
      if(id==='exportBtn') exportCSV(filteredRows());
      if(id==='refreshBtn') fetchData(true);
      if(id==='downloadsBtn') document.getElementById('downloadsModal').style.display='grid';
      if(id==='closeDownloads') document.getElementById('downloadsModal').style.display='none';
      if(id==='dlFullXLSX') exportXLSX(rows, 'full_data.xlsx');
      if(id==='dlFilteredXLSX') exportXLSX(filteredRows(), 'filtered_data.xlsx');
      if(id==='dlKPIsXLSX') exportKPIsXLSX();
    }
  });
});

['stateFilter','districtFilter','retailerFilter','cropFilter','languageFilter','statusFilter','productFilter','qtyMin','qtyMax'].forEach(id=>{ document.addEventListener('change', (e)=>{ if(e.target && e.target.id===id) rebuild(); }); });

document.getElementById('searchBox').addEventListener('input', ()=>{ clearTimeout(window.__sb); window.__sb=setTimeout(rebuild, 180); });

document.getElementById('csvInput').addEventListener('change', (e)=>{ const file=e.target.files?.[0]; if(!file) return; Papa.parse(file,{header:true,skipEmptyLines:true,complete:(res)=>{ normalizeAndParse(res.data); toast('Loaded from file'); }, error:(err)=> toast('CSV parse error: '+err, true)}); });

// ====== DATA LOAD ======
function normalizeAndParse(data){ productsMaster=new Set(); rows=data.map(r=>{ const o={}; columnsOrder.forEach(c=> o[c]= r[c]!==undefined? r[c]:'' ); o['Land Acreage']=toNumber(o['Land Acreage']); o._scanDate=parseDateSmart(o['Scan Date']); o._cartParsed=parseCartItems(o['Cart Items']); (o._cartParsed||[]).forEach(ci=> productsMaster.add(ci.name)); return o; }); buildFilters(); rebuild(); }

function csvUrlFromQuery(){ const u=new URL(location.href); const q=u.searchParams.get('csv'); return q?normalizeGithubUrl(decodeURIComponent(q)):normalizeGithubUrl(CSV_URL_DEFAULT); }

async function fetchData(isManual=false){ try{ showLoading(true); const url=csvUrlFromQuery(); const res=await fetch(url, { cache:'no-store' }); if(!res.ok) throw new Error('HTTP '+res.status+' for '+url); const text=await res.text(); const parsed=Papa.parse(text, { header:true, skipEmptyLines:true }); if(parsed.errors && parsed.errors.length){ console.warn('CSV parse errors', parsed.errors.slice(0,3)); }
  rawRows=parsed.data; if(!rawRows || !rawRows.length){ throw new Error('No rows in CSV'); }
  normalizeAndParse(rawRows); toast((isManual?'Refreshed':'Loaded')+' from CSV');
 } catch(err){ console.error(err); toast('Failed to load CSV. You can use Upload CSV (fallback).', true); }
 finally{ showLoading(false); }
}

function initApp(){ fetchData(false); if(AUTO_REFRESH_MS>0){ setInterval(()=>fetchData(), AUTO_REFRESH_MS); } }
</script>
</body>
</html>
